---
title: "R Notebook"
---

# Load libraries

```{r}

library(tidyverse)
library(lubridate)
library(patchwork) # for creating nice plot grids

```

# Theme options

```{r}

# Spruce up the default figure formatting
theme_set(theme_minimal() +
          theme(text = element_text(size = 12),
                axis.title.x = element_text(margin = margin(20, 0, 0, 0)),
                axis.title.y = element_text(margin = margin(0, 20, 0, 0)),
                legend.key.size = unit(0.5, "cm"),
                legend.text = element_text(size = 10),
                panel.border = element_rect(color = "#E0E0E0", size = 0.5, fill = NA),
                strip.background = element_rect(fill = "#FAFAFA", color = "#E0E0E0"),
                panel.spacing = unit(2, "lines")))

# Create custom date scale
sample_date <- "2020-04-06"
custom_date_scale <- scale_x_date(date_breaks = "7 days",
                                  date_minor_breaks = "1 day",
                                  date_labels = "%b %d",
                                  expand = c(0.01, 0),
                                  limits = c(ymd("2020-01-16"), ymd(sample_date)))

# Color palette
# Colors correspond to the 500-level colors from the Material Design color
# scheme. See https://material-ui.com/customization/color/
palette_colors <- c(
  `red`         = "#F44336",
  `pink`        = "#E91E63",
  `purple`      = "#9C27B0",
  `deep purple` = "#673AB7",
  `indigo`      = "#3F51B5",
  `blue`        = "#2196F3",
  `light blue`  = "#03A9F4",
  `cyan`        = "#00BCD4",
  `teal`        = "#009688",
  `green`       = "#4CAF50",
  `light green` = "#8BC34A",
  `lime`        = "#CDDC39",
  `yellow`      = "#FFEB3B",
  `amber`       = "#FFC107",
  `orange`      = "#FF9800",
  `deep orange` = "#FF5722",
  `brown`       = "#795548",
  `grey`        = "#9E9E9E",
  `blue grey`   = "#607D8B")


# Retrieve a specific color from the palette
palette <- function(color) {
  cols <- c(color)
  if (is.null(cols)) {
    return(NA)
  } else {
    return(unname(palette_colors[color]))
  }
}

```

# Load datasets

```{r}

# Dataset of COVID-19 cases and deaths. Data is aggregated from the repository
# maintained by Johns Hopkins (https://github.com/CSSEGISandData/COVID-19)
covid <- read_csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/worldwide-aggregated.csv")

# Preprint data generated here
preprints <- read_csv("data/preprint_details.csv")
preprint_usage <- read_csv("data/preprint_usage.csv")
preprint_altmetrics <- read_csv("data/preprint_altmetrics.csv")

```

# Development of COVID-19 and preprints over time

```{r}

# Define text and coordinates for annotations
text_1 <- "WHO declares COVID-19 outbreak \n a Public Health Emergency of \n International Concern"
text_2 <- "WHO declares COVID-19 outbreak \n a pandemic"
x_1 <- ymd("2020-01-30")
x_2 <- ymd("2020-03-11")
y_1 <- covid %>% filter(Date == "2020-01-30") %>% pull(Confirmed)
y_2 <- covid %>% filter(Date == "2020-03-11") %>% pull(Confirmed)
line_length <- 500000
spacing <- 50000

# COVID-19 confirmed cases
p1 <- covid %>%
  ggplot(aes(x = Date, y = Confirmed)) +
  geom_line(color = palette("deep orange"), size = 1) +
  geom_point(color = palette("deep orange"), size = 1, shape = 21,
             fill = "white", stroke = 1) +
  annotate("text", x = x_1, y = y_1 + line_length + spacing, 
           label = text_1, vjust = 0, size = 3) +
  annotate("segment", x = x_1, xend = x_1,
           y = y_1 + line_length, yend = y_1 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  annotate("text", x = x_2, y = y_2 + line_length + spacing, 
           label = text_2, vjust = 0, size = 3) +
  annotate("segment", x = x_2, xend = x_2,
           y = y_2 + line_length, yend = y_2 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  labs(x = "", y = "Confirmed Cases") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale +
  ggsave("outputs/figures/partials/covid19_cases.png", width = 12, height = 6)

# COVID-19 deaths
p2 <- covid %>%
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line(color = palette("deep orange"), size = 1) +
  geom_point(color = palette("deep orange"), size = 1, shape = 21,
             fill = "white", stroke = 1) +
  labs(x = "", y = "Deaths") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale +
  ggsave("outputs/figures/partials/covid19_deaths.png", width = 12, height = 6)

dates <- seq(ymd("2020-01-01"), ymd("2020-04-06"), by = "days")


# Preprints uploaded to bioRxiv and medRxiv
p3 <- preprints %>%
  filter(covid_preprint == T) %>%
  count(source, posted_date) %>%
  complete(posted_date, nesting(source), fill = list(n = 0)) %>%
  group_by(source) %>%
  arrange(posted_date) %>%
  mutate(cumulative_n = cumsum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = source), 
            color = "#ffffff", size = 0.5) +
  labs(x = "", y = "Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale +
  scale_fill_manual(values = c(palette("deep purple"), palette("pink"))) +
  ggsave("outputs/figures/partials/preprint_development.png", width = 12, height = 6)

# Patchwork
p1 + p2 + p3 + plot_layout(ncol = 1) +
  ggsave("outputs/figures/covid19_preprint_development.png", width = 12, height = 9)

```

# Usage of bioRxiv/medRxiv preprints

```{r}

# Prepare data
d <- preprint_usage %>%
  group_by(source, doi, posted_date, covid_preprint) %>%
  summarize(abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ),
         covid_preprint = covid_preprint) %>%
  filter(posted_week >= "2020-01-16")

# Abstract views
p1 <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.1, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_abstract_views.png", width = 12, height = 6)

# PDF downloads
p2 <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.1, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_pdf_downloads.png", width = 12, height = 6)

# Patchwork
p1 + p2 + plot_layout(ncol = 1) +
  ggsave("outputs/figures/preprint_usage.png", width = 12, height = 9)

```



