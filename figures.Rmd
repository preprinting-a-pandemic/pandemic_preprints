---
title: "R Notebook"
---

# Load libraries

```{r}

library(tidyverse)
library(magrittr)
library(lubridate)
library(ggalluvial)
library(ggrepel)
library(patchwork) # for creating nice plot grids

```

# Theme options

```{r}

# Spruce up the default figure formatting
theme_set(theme_minimal() +
            theme(text = element_text(size = 12),
                  axis.title.x = element_text(margin = margin(20, 0, 0, 0)),
                  axis.title.y = element_text(margin = margin(0, 20, 0, 0)),
                  legend.key.size = unit(0.5, "cm"),
                  legend.text = element_text(size = 10),
                  panel.border = element_rect(color = "#E0E0E0", size = 0.5, fill = NA),
                  strip.background = element_rect(fill = "#FAFAFA", color = "#E0E0E0"),
                  panel.spacing = unit(2, "lines")))

# Create custom date scale
sample_date <- "2020-04-06"
custom_date_scale <- scale_x_date(date_breaks = "7 days",
                                  date_minor_breaks = "1 day",
                                  date_labels = "%b %d",
                                  expand = c(0.01, 0),
                                  limits = c(ymd("2020-01-16"), ymd(sample_date)))

# Color palette
# Colors correspond to the 500-level colors from the Material Design color
# scheme. See https://material-ui.com/customization/color/
palette_colors <- c(
  `red`         = "#F44336",
  `pink`        = "#E91E63",
  `purple`      = "#9C27B0",
  `deep purple` = "#673AB7",
  `indigo`      = "#3F51B5",
  `blue`        = "#2196F3",
  `light blue`  = "#03A9F4",
  `cyan`        = "#00BCD4",
  `teal`        = "#009688",
  `green`       = "#4CAF50",
  `light green` = "#8BC34A",
  `lime`        = "#CDDC39",
  `yellow`      = "#FFEB3B",
  `amber`       = "#FFC107",
  `orange`      = "#FF9800",
  `deep orange` = "#FF5722",
  `brown`       = "#795548",
  `grey`        = "#9E9E9E",
  `blue grey`   = "#607D8B")


# Retrieve a specific color from the palette
palette <- function(color) {
  cols <- c(color)
  if (is.null(cols)) {
    return(NA)
  } else {
    return(unname(palette_colors[color]))
  }
}

```

# Load datasets

```{r}

# Dataset of COVID-19 cases and deaths. Data is aggregated from the repository
# maintained by Johns Hopkins (https://github.com/CSSEGISandData/COVID-19)
covid <- read_csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/worldwide-aggregated.csv")

# Preprint data generated here
preprints <- read_csv("data/preprint_details.csv")
preprint_usage <- read_csv("data/preprint_usage.csv")
preprint_altmetrics <- read_csv("data/preprint_altmetrics.csv")
preprint_timing <- read_csv("data/preprint_earliest_per_country.csv")
preprint_1 <- read.csv("data/preprints_basic_20131101_20181231.csv", stringsAsFactors = FALSE)
preprint_2 <- read.csv("data/preprints_basic_20190101_20200430.csv", stringsAsFactors = FALSE)
preprints_all <- bind_rows(preprint_1, preprint_2)

# Load previous citation counts fetched?
load_prev_citations <- TRUE
```

# Development of COVID-19 and preprints over time

```{r}

# Define text and coordinates for annotations
text_1 <- "WHO declares COVID-19 outbreak \n a Public Health Emergency of \n International Concern"
text_2 <- "WHO declares COVID-19 outbreak \n a pandemic"
x_1 <- ymd("2020-01-30")
x_2 <- ymd("2020-03-11")
y_1 <- covid %>% filter(Date == "2020-01-30") %>% pull(Confirmed)
y_2 <- covid %>% filter(Date == "2020-03-11") %>% pull(Confirmed)
line_length <- 500000
spacing <- 50000

# COVID-19 confirmed cases
p1 <- covid %>%
  ggplot(aes(x = Date, y = Confirmed)) +
  geom_line(color = palette("deep orange"), size = 1) +
  geom_point(color = palette("deep orange"), size = 1, shape = 21,
             fill = "white", stroke = 1) +
  annotate("text", x = x_1, y = y_1 + line_length + spacing, 
           label = text_1, vjust = 0, size = 3) +
  annotate("segment", x = x_1, xend = x_1,
           y = y_1 + line_length, yend = y_1 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  annotate("text", x = x_2, y = y_2 + line_length + spacing, 
           label = text_2, vjust = 0, size = 3) +
  annotate("segment", x = x_2, xend = x_2,
           y = y_2 + line_length, yend = y_2 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  labs(x = "", y = "Confirmed Cases") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale +
  ggsave("outputs/figures/partials/covid19_cases.png", width = 12, height = 6)

# COVID-19 deaths
p2 <- covid %>%
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line(color = palette("deep orange"), size = 1) +
  geom_point(color = palette("deep orange"), size = 1, shape = 21,
             fill = "white", stroke = 1) +
  labs(x = "", y = "Deaths") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale +
  ggsave("outputs/figures/partials/covid19_deaths.png", width = 12, height = 6)

dates <- seq(ymd("2020-01-01"), ymd("2020-04-06"), by = "days")


# Preprints uploaded to bioRxiv and medRxiv
p3 <- preprints %>%
  filter(covid_preprint == T) %>%
  count(source, posted_date) %>%
  complete(posted_date, nesting(source), fill = list(n = 0)) %>%
  group_by(source) %>%
  arrange(posted_date) %>%
  mutate(cumulative_n = cumsum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = source), 
            color = "#ffffff", size = 0.5) +
  labs(x = "", y = "Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale +
  scale_fill_manual(values = c(palette("deep purple"), palette("pink"))) +
  ggsave("outputs/figures/partials/preprint_development.png", width = 12, height = 6)

# Patchwork
p1 + p2 + p3 + plot_layout(ncol = 1) +
  ggsave("outputs/figures/covid19_preprint_development.png", width = 12, height = 9)

```

# Usage of bioRxiv/medRxiv preprints

```{r}

# Prepare data
d <- preprint_usage %>%
  group_by(source, doi, posted_date, covid_preprint) %>%
  summarize(abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ),
         covid_preprint = covid_preprint) %>%
  filter(posted_week >= "2020-01-16")

# Abstract views
p1 <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.1, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_abstract_views.png", width = 12, height = 6)

# PDF downloads
p2 <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.1, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_pdf_downloads.png", width = 12, height = 6)

# Patchwork
p1 + p2 + plot_layout(ncol = 1) +
  ggsave("outputs/figures/preprint_usage.png", width = 12, height = 9)

```

# Timing of first preprint and first case per country 

```{r}

# Plot timing
g1 <- case_author_dates_df %>% 
  mutate(continent = countrycode::countrycode(institution_match_country_code, origin = 'iso2c', destination = 'continent')) %>% 
  filter(!is.na(first_preprint) & !is.na(first_case)) %>%
  ggplot(aes(x = first_case, y = first_preprint, label = institution_match_country_name)) +
  geom_point(aes(color = continent), size=2) +
  geom_text_repel(size = 3, force = 1.2, segment.size = 0.2) +
  xlab("Date of first confirmed case") +
  ylab('Date of first preprint authorship') +
  geom_abline(intercept = 0, slope = 1, color="grey50", lty="dashed", alpha=0.5) +
  ggsave("outputs/figures/partials/preprint_case_to_preprint_scatter.png", width = 10, height = 8)

# Plot histogram of lag
g2 <- preprint_timing %>%
  ggplot(aes(x=lag)) +
  geom_histogram(bins=30) +
  scale_x_continuous(breaks=seq(-40, 80, 20), limits = c(-40, 80)) +
  xlab("Days from first case until first preprint") +
  ylab("Frequency") +
  ggsave("outputs/figures/partials/preprint_case_to_preprint_hist.png", width = 10, height = 5)
```

# Time until publication

```{r}

# Prepare data

# Identify proportion of preprints that are published
preprints %>% filter(source == "biorxiv") %>% with(table(covid_preprint, is_published)) %>% prop.table(margin = 1)*100 %>% round(3)
preprints %>% filter(source == "medrxiv") %>% with(table(covid_preprint, is_published)) %>% prop.table(margin = 1)*100 %>% round(3)

# Calculate time to publishing
preprints %<>% mutate(time_to_publish = as.Date(published_date) - as.Date(posted_date))

# Identify any preprints published before or at same time as preprint upload
publish_before_preprint <- preprints %>% filter(time_to_publish <= 0)

# Identify publishers with at least 10 published preprints across entire dataset
publisher_list <- preprints %>% pull(published_publisher) %>% table %>% as.data.frame %>% arrange(Freq) %>% filter(Freq > 10) %>% pull(".")

# Plot density of time to publishing for COVID-19/non-COVID-19 preprints by server
g1 <- preprints %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints")
  ) %>%
  filter(time_to_publish > 0) %>%
  ggplot(aes(x=time_to_publish, fill=covid_preprint, color=covid_preprint)) +
  geom_density(alpha=0.6) +
  #  scale_x_continuous(breaks=seq(-60, 80, 20), limits = c(-60, 80)) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  xlab("Time from preprint posting to publication (days)") +
  ylab("Density") +
  scale_color_manual(values = c(palette("deep orange"), palette("blue grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("blue grey"))) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_time_all.png", width = 10, height = 6)

# Plot boxes of time to publishing for COVID-19/non-COVID-19 preprints by server & publisher
g2 <- preprints %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints")
  ) %>%
  filter(time_to_publish > 0 & published_publisher %in% publisher_list) %>%
  ggplot(aes(x = published_publisher, y = time_to_publish, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Publisher", y = "Time from preprint posting to publication (days)", 
       fill = "", color = "") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_x_discrete(label=abbreviate) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_publishing_time_server.png", width = 10, height = 8)
```

# Citation counts
```{r}

# Prepare data

# Extract citation counts for all preprint and published dois using CrossRef API
if (load_prev_citations == TRUE){
  load(file="data\\citations.RData")
} else {
  preprint_citation_lookup <- preprints %>% pull(doi) %>% cr_citation_count %>% rename(preprint_citations = count)
  published_citation_lookup <- preprints %>% filter(!is.na(published_doi)) %>% pull(published_doi) %>% cr_citation_count %>% rename(published_citations = count, published_doi = doi)
  save(preprint_citation_lookup, published_citation_lookup, file="data\\citations.RData")
}

# Append to list of preprints
preprints %<>%
  left_join(preprint_citation_lookup, by = "doi") %>%
  left_join(published_citation_lookup, by = "published_doi") %>% 
  replace_na(list(preprint_citations = 0, published_citations = 0)) %>%
  mutate(total_citations = preprint_citations + published_citations)

# Plot total citations 
g1 <- preprints %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints")
  ) %>%
  ggplot(aes(x = covid_preprint, y = total_citations, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "", y = "Citations (log scale)", 
       fill = "", color = "") +
  scale_y_continuous(trans='log10') +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/preprint_citations_total.png", width = 5, height = 6)

# Plot individual preprint/published citations 
g2 <- preprints %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19",
    covid_preprint == F ~ "non-COVID-19")
  ) %>% select(doi, covid_preprint, source, preprint_citations, published_citations) %>%
  gather(type, count, -doi, -covid_preprint, -source) %>%
  mutate(type = case_when(
    type == "preprint_citations" ~ "Preprint",
    type == "published_citations" ~ "Publication")) %>%
  ggplot(aes(x = type, y = count, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Article version", y = "Citations (log scale)", 
       fill = "", color = "") +
  scale_y_continuous(trans='log10') +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_citations_split.png", width = 10, height = 8)

```

# Science focus of senior author
```{r}

# For each author, select their chronologically latest COVID-19 preprint
preprint_author_last <- preprints %>% 
  filter(covid_preprint == TRUE) %>% 
  arrange(posted_date) %>% 
  group_by(author_corresponding) %>% 
  slice(n())

# For each author, extract the category of their last preprint
preprint_author_last %<>% left_join(preprints_all %>% 
                                      filter(author_corresponding %in% preprint_author_last$author_corresponding & !(doi %in% preprint_author_last$doi)) %>% 
                                      arrange(posted_date) %>% 
                                      group_by(author_corresponding) %>% 
                                      slice(n()),
                                    by = "author_corresponding") %>%
  rename_at(vars(contains(".x")), ~ gsub("\\.x","_covid",.)) %>%
  rename_at(vars(contains(".y")), ~ gsub("\\.y","_previous",.)) %>% 
  mutate(category_covid = tolower(category_covid), category_previous = tolower(category_previous)) %>%
  ungroup

# Append to list of preprints
preprints %<>%
  left_join(preprint_citation_lookup, by = "doi") %>%
  left_join(published_citation_lookup, by = "published_doi") %>% 
  replace_na(list(preprint_citations = 0, published_citations = 0)) %>%
  mutate(total_citations = preprint_citations + published_citations)

# Plot alluvial diagram
g1 <- ggplot(data = preprint_author_last %>% 
         filter(!is.na(category_previous)) %>% 
         select(category_covid, category_previous) %>% 
         plyr::count() %>%
         filter(freq >= 5),
       aes(axis1 = category_previous, axis2 = category_covid, y = freq)) +
  scale_x_discrete(limits = c("Previous", "COVID-19"), expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Preprint categorisation") +
  ylab("Frequency") +
  geom_alluvium(aes(fill=category_previous), reverse=TRUE) +
  geom_stratum(reverse=TRUE) + 
  geom_text(size = 3.2, stat = "stratum", label.strata = TRUE, reverse=TRUE, size=0.8) +
  #  geom_text(aes(label = freq), color="gray50", nudge_x=0.23, stat = "alluvium", reverse = TRUE) +
  geom_text(aes(label = freq), size = 3.2, color="gray30", nudge_x=0.14, stat = "stratum", reverse = TRUE) +
  guides(fill=FALSE) +
  theme_bw() +
  ggsave("outputs/figures/partials/preprint_science_focus.png", width = 8, height = 10)
```