---
title: "R Notebook"
---

# Load libraries

```{r}

library(tidyverse)
library(magrittr)
library(lubridate)
library(ggalluvial)
library(ggrepel)
library(corrr) # for correlation matrix
library(patchwork) # for creating nice plot grids
library(colorspace) # better color palettes

```

# Theme options

```{r}

# Spruce up the default figure formatting
theme_set(theme_minimal() +
            theme(text = element_text(size = 12),
                  axis.title.x = element_text(size = 12,
                                              margin = margin(10, 0, 5, 0)),
                  axis.title.y = element_text(size = 12,
                                              margin = margin(0, 10, 0, 5)),
                  panel.border = element_rect(color = "#E0E0E0", size = 0.5, fill = NA),
                  plot.margin = margin(5, 5, 5, 5),
                  plot.caption = element_text(size = 12, hjust = 0,
                                              margin = margin(20, 0, 0, 0)),
                  plot.caption.position =  "panel",
                  legend.key.size = unit(0.5, "cm")))

# Make sure axis labels (e.g. month names) are in English
Sys.setlocale("LC_ALL", "English")

# Create custom date scale
custom_date_scale <- function(start_date, end_date) {
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d",
               expand = c(0, 0),
               limits = c(ymd(start_date), ymd(end_date)))
}

```

# Load datasets

```{r}

# Dataset of COVID-19 cases and deaths. Data is aggregated from the repository
# maintained by Johns Hopkins (https://github.com/CSSEGISandData/COVID-19)
covid <- read_csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/worldwide-aggregated.csv")

# Main preprint datasets generated here
preprints <- read_csv("data/preprints_full_20190901_20200430.csv",
                      col_types = cols(n_refs = "n", n_words = "n")) # fix reading issue with word + ref counts
preprints_epi_period <- preprints %>% filter(posted_date >= "2020-01-01") # Subset preprints by period for ease
preprints_control_period <- preprints %>% filter(posted_date < "2020-01-01")
preprint_usage <- read_csv("data/preprint_usage_20190901_20200430.csv")
preprint_citations <- read_csv("data/preprint_citations_20190901_20200430.csv")
preprint_altmetrics <- read_csv("data/preprint_altmetrics_20190901_20200430.csv")
preprint_timing <- read_csv("data/preprint_earliest_per_country_20200101_20200430.csv")

# Reconstruct dataset of ALL preprints
preprint_1 <- read.csv("data/preprints_basic_20131101_20181231.csv", stringsAsFactors = FALSE)   
preprint_2 <- read.csv("data/preprints_basic_20190101_20200430.csv", stringsAsFactors = FALSE)
preprints_all <- bind_rows(preprint_1, preprint_2)

# Full dataset of preprints from other servers
preprints_other <- read_csv("https://raw.githubusercontent.com/nicholasmfraser/covid19_preprints/master/data/covid19_preprints.csv", col_types = "cccccc")

# Journal articles
journal_articles <- read_csv("data/journal_articles_20200101_20200430.csv")

```

# Figure 1: Development of COVID-19, journal articles and preprints over time

```{r}

# Panel A: Development of COVID-19 cases and deaths

# Define text and coordinates for annotations
text_1 <- "WHO declares COVID-19 \n outbreak a Public Health \n Emergency of \n International Concern"
text_2 <- "WHO declares COVID-19 \n outbreak a pandemic"
x_1 <- ymd("2020-01-30")
x_2 <- ymd("2020-03-11")
y_1 <- covid %>% filter(Date == "2020-01-30") %>% pull(Confirmed)
y_2 <- covid %>% filter(Date == "2020-03-11") %>% pull(Confirmed)
line_length <- 1000000
spacing <- 100000

p1A <- covid %>%
  select(Date, Confirmed, Deaths) %>%
  rename(Cases = Confirmed) %>%
  pivot_longer(Cases:Deaths) %>%
  ggplot(aes(x = Date, y = value, color = name)) +
  geom_line(size = 1) +
  geom_point(size = 1, shape = 21, fill = "white", stroke = 1) +
  annotate("text", x = x_1, y = y_1 + line_length + spacing, 
           label = text_1, vjust = 0, size = 3) +
  annotate("segment", x = x_1, xend = x_1,
           y = y_1 + line_length, yend = y_1 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  annotate("text", x = x_2, y = y_2 + line_length + spacing, 
           label = text_2, vjust = 0, size = 3) +
  annotate("segment", x = x_2, xend = x_2,
           y = y_2 + line_length, yend = y_2 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  labs(x = "", y = "Confirmed Cases / Deaths", color = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1A.png", width = 10, height = 5)

# Panel B: Number of journal articles and preprints on COVID-19

p1B <- preprints_other %>%
  mutate(posted_date = as.Date(posted_date),
         type = "Preprints") %>%
  bind_rows(journal_articles %>% 
            mutate(posted_date = created,
                   type = "Journal Articles")) %>%
  count(type, posted_date) %>%
  complete(posted_date, nesting(type), fill = list(n = 0)) %>%
  group_by(type) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = reorder(type, -total_n)), 
            color = "grey50", size = 0.5) +
  labs(x = "", y = "Articles / Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1B.png", width = 10, height = 5)

# Panel C: Preprints on COVID-19 from multiple sources

# Find the repositories that have > X preprints
n_min <- 100
other <- preprints_other %>%
  count(source) %>%
  filter(n < n_min) %>%
  pull(source)

# Define the levels for facetting (to order sources by publication volume)
fct_levels <- preprints_other %>% 
  mutate(source = case_when(
           source %in% other ~ "Other",
           T ~ source
        )) %>%
  count(source) %>%
  arrange(desc(n)) %>%
  mutate(source = c(source[source != "Other"], "Other")) %>%
  pull(source)

p1C <- preprints_other %>%
  mutate(posted_date = as.Date(posted_date),
         source = case_when(
           source %in% other ~ "Other",
           T ~ source),
        source = factor(source, levels = fct_levels)) %>%
  count(source, posted_date) %>%
  complete(posted_date, nesting(source), fill = list(n = 0)) %>%
  group_by(source) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = source), 
            color = "grey50", size = 0.5) +
  labs(x = "", y = "Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_fill_manual(values = qualitative_hcl(12, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1C.png", width = 10, height = 5)

# Figure caption
caption <- str_wrap("Figure 1: Development of COVID-19 and publication response between January 2020 and April 2020. (A) Number of COVID-19 confirmed cases and reported deaths. Data is sourced from https://github.com/datasets/covid-19/, based on case and death data aggregated by the Johns Hopkins University Center for Sysmtems Science and Engineering (https://systems.jhu.edu/). (B) Cumulative growth of journal articles and preprints containing COVID-19 related search terms. (C) Cumulative growth of preprints containing COVID-19 related search terms, broken down by individual preprint server. Journal data in (B) is based upon data extracted from Dimensions (https://www.dimensions.ai), preprint data in (B) and (C) is based upon data gathered by Fraser and Kramer (2020; https://doi.org/10.6084/m9.figshare.12033672).", width = 125)

# Patchwork
p1A + p1B + p1C + plot_layout(ncol = 1) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_1.png", width = 10, height = 10)

```

# Supplementary Figure 1: Number of preprints in relation to previous epidemics (Zika, Ebola)

```{r}

# Build search strings containing terms related to other epidemics
search_string_ebola <- "ebola|ZEBOV"
search_string_zika <- "zika|ZIKV"

# Set dates of all epidemics
covid_start <- "2020-01-01"
covid_end <- "2020-04-30"

ebola_start <- "2014-01-24"
ebola_end <- "2016-06-09"  # Outbreak declared ended: https://apps.who.int/iris/bitstream/handle/10665/208883/ebolasitrep_10Jun2016_eng.pdf

zika_start <- "2015-03-02"
zika_end <- "2016-11-18"  # Public health emergency declared ended: https://www.who.int/en/news-room/detail/18-11-2016-fifth-meeting-of-the-emergency-committee-under-the-international-health-regulations-(2005)-regarding-microcephaly-other-neurological-disorders-and-zika-virus

# Determine preprint counts of previous epidemics
covid_counts <- preprints %>% 
                  filter(posted_date >= covid_start) %>% 
                  rename(epi_preprint = covid_preprint) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "COVID-19")

ebola_counts <- preprints_all %>% 
                  filter(posted_date >= ebola_start & posted_date <= ebola_end) %>%
                  mutate(epi_preprint = case_when(
                    str_detect(title, regex(search_string_ebola, ignore_case = TRUE)) ~ T, 
                    str_detect(abstract, regex(search_string_ebola, ignore_case = TRUE)) ~ T,
                    T ~ F)) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "Western Africa Ebola virus")

zika_counts <- preprints_all %>% 
                  filter(posted_date >= zika_start & posted_date <= zika_end) %>%
                  mutate(epi_preprint = case_when(
                    str_detect(title, regex(search_string_zika, ignore_case = TRUE)) ~ T, 
                    str_detect(abstract, regex(search_string_zika, ignore_case = TRUE)) ~ T,
                    T ~ F)) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "Zika virus")

# Figure caption
caption <- str_wrap("Supplementary Figure 1: Comparison of preprint posting volume during periods of major RNA virus epidemics: (A) Western Africa Ebola virus, (B) Zika virus, (C) COVID-19. For each panel, the number of preprints posted that were related to the epidemic, and the number that were posted but not related to the epidemic in the same time period are shown. Periods of data collection for Western Africa Ebola virus (24th January 2014 - 9th June 2016) and Zika virus (2nd March 2015 - 18th November 2016) correspond to the periods between the first official medical report, and the time at which the World Health Organization declared the end of the Public Health Emergency of International Concern. The period of data collection for COVID-19 refers to the analysis period used in this study, 1st January 2020 to 30th April 2020.", width = 125)

# Generate plot
pS1 <- bind_rows(covid_counts, ebola_counts, zika_counts) %>% 
  mutate(epi_preprint = case_when(
      epi_preprint == T ~ "Epidemic-related preprints",
      epi_preprint == F ~ "Non-epidemic preprints"),
    epidemic = factor(epidemic, levels=c("Western Africa Ebola virus", "Zika virus", "COVID-19"))) %>%
  ggplot(aes(x = epi_preprint, y = n, colour = epi_preprint, fill = epi_preprint)) +
  geom_bar(stat = "identity") +
  labs(x = "Epidemic", y = "Total preprints", fill = "", color = "",
       caption = caption) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  facet_wrap(epidemic ~ ., strip.position = "bottom") +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(),
        plot.caption = element_text(hjust = 0),
        plot.caption.position = "plot") +
  ggsave("outputs/figures/Figure_S1.png", width = 10, height = 5)

```

# Figure 2: Preprint attributes

```{r}

# Panel A: Numbers of COVID vs non-COVID preprints
# Limit to preprints posted between January and April 2020

p2A <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  count(covid_preprint, posted_week) %>%
  complete(posted_week, nesting(covid_preprint), fill = list(n = 0)) %>%
  ggplot(aes(x = posted_week, y = n, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Posted date (week beginning)", y = "Preprints deposited", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_2A.png", width = 10, height = 5)

# Panel B: Countries depositing COVID/non-COVID preprints (top X)
# Limit to preprints posted between January and April 2020

top_countries <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(institution_match_country_code) %>%
  na.omit() %>%
  # select the number of countries to display
  top_n(10, n) %>%
  arrange(desc(n)) %>%
  pull(institution_match_country_code)

p2B <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  
  count(covid_preprint, institution_match_country_code) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  filter(institution_match_country_code %in% top_countries) %>%
  mutate(institution_match_country_code = factor(institution_match_country_code, 
                                                 levels = top_countries),
    covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = institution_match_country_code, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "", y = "% of corresponding authors", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2B.png", width = 5, height = 5)

# Panel C: First case -> first preprint by location

p2C <- preprint_timing %>%
  mutate(continent = countrycode::countrycode(institution_match_country_code, 
                                              origin = 'iso2c', destination = 'continent')) %>% 
  filter(!is.na(first_preprint) & !is.na(first_case) & !is.na(continent)) %>%
  ggplot(aes(x = first_case, y = first_preprint, label = institution_match_country_code)) +
  geom_point(aes(color = continent), size=2) +
  geom_text_repel(force = 5,
                  segment.color = "grey50",
                  segment.size = 0.2,
                  segment.alpha = 0.8,
                  color = "grey25", 
                  size = 2.5) +
  geom_abline(intercept = 0, slope = 1, color = "grey50", lty = "dashed", alpha = 0.5) +
  labs(x = "Date of first case",
       y = "Date of first preprint",
       color = "") +
  scale_color_manual(values = qualitative_hcl(5, palette = "Set2")) +
  coord_cartesian(ylim = c(ymd("2020-01-01", "2020-04-30")),
                  xlim = c(ymd("2020-01-01", "2020-04-30"))) +
  theme(legend.margin = margin(0, 0, 0, 0)) +
  ggsave("outputs/figures/partials/Figure_2C.png", width = 5, height = 5)

# Panel D: Author numbers

p2D <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(n_authors = map_int(authors, ~(length(str_split(., ";")[[1]])))) %>%
  count(covid_preprint, n_authors) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  filter(n_authors <= 25) %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = n_authors, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Number of authors", y = "% of preprints", fill = "") +
  scale_x_continuous(breaks = seq(from = 1, to = 30, by = 2)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(legend.position = "bottom") +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2D.png", width = 5, height = 5)

# Panel E: Preprints per senior authors

p2E <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(author_corresponding, covid_preprint) %>%
  count(n, covid_preprint) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (nn/sum(nn) * 100)) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  ggplot(aes(x = n, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Number of preprints", y = "% of corresponding authors", fill = "") +
  scale_x_continuous(breaks = seq(1:12)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2E.png", width = 5, height = 5)

# Panel F: Revisions per preprint for COVID vs non-COVID

p2F <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(covid_preprint, n_versions) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = n_versions, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Number of versions", y = "% of preprints", fill = "") +
  scale_x_continuous(breaks = seq(1:10)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(legend.position = "bottom") +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2F.png", width = 5, height = 5)

# Panel G: Word counts

p2G <- preprints %>%
  filter(posted_date >= "2020-01-01",
         source == "biorxiv") %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = covid_preprint, y = n_words, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2, width = 0.3) +
  labs(x = "", y = "Word Count", fill = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  theme(legend.position = "none") +
  guides(color = FALSE) +
  ggsave("outputs/figures/partials/Figure_2G.png", width = 5, height = 5)

# Panel H: Reference counts

p2H <- preprints %>%
  filter(posted_date >= "2020-01-01",
         source == "biorxiv") %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = covid_preprint, y = n_refs, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2, width = 0.3) +
  labs(x = "", y = "Reference Count", fill = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  theme(legend.position = "none") +
  guides(color = FALSE) +
  ggsave("outputs/figures/partials/Figure_2H.png", width = 5, height = 5)

# Figure caption
caption <- str_wrap("Figure 2: Attributes of COVID-19 and non-COVID-19 preprints deposited on bioRxiv and medRxiv between January and April 2020. (A) Number of preprints deposited per week. (B) Percentage of preprints deposited by country of corresponding author. (C) Correlation between date of the first preprint originating from a country (according to the affiliation of the corresponding author) and the date of the first confirmed case from the same country for COVID-19 preprints. (D) Distribution of the number of authors per preprint. (E) Distribution of the number of preprints posted by the same corresponding author. (F) Distribution of the number of deposited preprint versions. (G) Word counts per preprints. (H) Reference counts per preprint", width = 120)

# define layout manually - see https://patchwork.data-imaginist.com/articles/guides/layout.html
layout <- "
AAAAAAAAAAAA
BBBBBBCCCCCC
DDDDDDEEEEEE
FFFFFFGGGHHH
"
p <- p2A + p2B + p2C + p2D + p2E + p2F + p2G + p2H + 
  plot_layout(design = layout) & theme(legend.position = "top")

# For some reason this throws an error but still actually works fine...
p + plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_2.png", width = 10, height = 12.5) 
  
```

# Supplementary Figure 2:

```{r}

# Panel A: COVID vs non-COVID preprints for bioRxiv only

pS2A <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ),
         source = factor(source, 
                         levels = c("biorxiv", "medrxiv"),
                         labels = c("bioRxiv", "medRxiv"))) %>%
  count(covid_preprint, source, posted_week) %>%
  complete(posted_week, nesting(covid_preprint, source), fill = list(n = 0)) %>%
  ggplot(aes(x = posted_week, y = n, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Posted date (week beginning)", y = "Preprints deposited", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  facet_wrap(. ~ source, nrow = 2, strip.position = "right") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.background = element_rect(color = "grey90", fill = "grey95",)) +
  ggsave("outputs/figures/partials/Figure_S2A.png", width = 10, height = 5)

# Panel B: Preprint screening time
pS2B <- ggplot(data.frame()) + 
  geom_point() + 
  xlim(0, 1) + ylim(0, 1) + 
  annotate("text", x = 0.5, y = 0.5, label = "Placeholder [Screening times]")

# Panel C: License types
pS2C <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(covid_preprint, license) %>%
  na.omit() %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = license, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "License Type", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S2C.png", width = 5, height = 5)

# Panel D: Institutions of senior authors

# Determine top-20 institutions
top_institutions <- preprints %>%
  count(institution_match_name) %>%
  na.omit() %>%
  top_n(20, n) %>%
  pull(institution_match_name)

pS2D <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(covid_preprint, institution_match_name) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  filter(institution_match_name %in% top_institutions) %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = institution_match_name, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S2C.png", width = 10, height = 5)

# Caption
caption <- "Supplementary Figure 2: [tbc]"

# Patchwork
pS2A + (pS2B | pS2C ) +  pS2D +
  plot_layout(nrow = 3, heights = c(1.5, 1, 1)) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_S2.png", width = 10, height = 10)

```

# Figure 3: Preprint access

```{r}

# Prepare data
d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  group_by(doi, posted_date, covid_preprint) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ))

# Abstract views
p3A <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_3A.png", width = 10, height = 5)

# PDF downloads
p3B <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_3B.png", width = 10, height = 5)

# Write figure caption
caption <- str_wrap("Figure 3: Distribution of access statistics for COVID-19 and non-COVID-19 preprints posted on bioRxiv and medRxiv. (A) Total abstract views. (B) Total PDF downloads.", width = 125)

# Patchwork
p3A + p3B + plot_layout(ncol = 1) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_3.png", width = 10, height = 7.5)

```

# Supplementary Figure 3: Time prior to our study period

```{r}

# Panel A: Abstract views (bioRxiv + medRxiv, non-COVID)

d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  filter(covid_preprint != T) %>%
  group_by(doi, posted_date) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1))

pS3A <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, group = posted_week)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2) +
  annotate("rect", xmin = ymd("2020-01-01"), xmax = ymd("2020-04-30"),
           ymin = 1, ymax = 1e5, fill = "red", alpha = 0.2) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e5), expand = c(0, 0)) +
  custom_date_scale("2019-09-01", "2020-04-30") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S3A.png", width = 12, height = 6)

# Panel B: PDF downloads (bioRxiv + medRxiv, non-COVID)

pS3B <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, group = posted_week)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2) +
  annotate("rect", xmin = ymd("2020-01-01"), xmax = ymd("2020-04-30"),
           ymin = 1, ymax = 1e5, fill = "red", alpha = 0.2) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e5), expand = c(0, 0)) +
  custom_date_scale("2019-09-01", "2020-04-30") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S3B.png", width = 12, height = 6)

# Panel C: Abstract views (bioRxiv vs medRxiv, COVID)

d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  filter(covid_preprint == T) %>%
  group_by(doi, source, posted_date) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1))

pS3C <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, color = source,
             group = interaction(posted_week, source))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(source)),
              shape = 21, size = 0.2, alpha = 0.2, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S3C.png", width = 10, height = 5)

# Panel D: PDF downloads (bioRxiv vs medRxiv, COVID)

pS3D <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, color = source,
             group = interaction(posted_week, source))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(source)),
              shape = 21, size = 0.2, alpha = 0.2, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S3D.png", width = 10, height = 5)

# Panel E: PDF downloads for additional preprint servers

# Build a search string containing terms related to COVID-19
search_string_covid <- "coronavirus|covid-19|sars-cov|ncov-2019|2019-ncov|hcov-19|sars-2"

# Read in and process data from other servers

# SSRN
ssrn_preprints <- read.csv("data/otherservers/ssrn_extract_3_LB.csv", 
                           stringsAsFactors = FALSE, 
                           fileEncoding = "UTF-8-BOM") %>%
  rename_all(~tolower(str_replace_all(.,"\\.|X\\.",""))) %>%
  group_by(abstract_id, ab_title) %>%
  summarise(pdf_downloads = sum(total_downloads)) %>%
  mutate(covid_preprint = case_when(
    str_detect(ab_title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
    T ~ F),
    source = "SSRN") %>% 
  ungroup()

# Research Square
#ressquare_titles <- read.csv("data/otherservers/article_data.csv", 
#                             stringsAsFactors = FALSE) %>% 
#  select(article_identity, title)

#ressquare_texts <- read.csv("data/otherservers/full_article_text-002.csv", 
#                            stringsAsFactors = FALSE) %>% 
#  select(article_identity, plain_abstract)

ressquare_preprints <- read.csv("data/otherservers/engagement_by_article_and_date.csv", 
                                stringsAsFactors = FALSE) %>%
  left_join(ressquare_titles, by = "article_identity") %>%
  left_join(ressquare_texts, by = "article_identity") %>%
  group_by(article_identity, title, plain_abstract) %>%
  summarise(pdf_downloads = sum(downloads)) %>%
  mutate(covid_preprint = case_when(
    str_detect(title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
    str_detect(plain_abstract, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    T ~ F),
    source = "Research Square") %>% 
  ungroup()

# Preprints.org
dotorg_preprints <- read.csv("data/otherservers/2020-01-01-2020-04-30_preprints_dot_org.csv", 
                             stringsAsFactors = FALSE) %>%
  rename(pdf_downloads = downloads) %>%
  mutate(covid_preprint = case_when(
    str_detect(title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
    str_detect(abstract, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    T ~ F),
    source = "Preprints.org")

# Bind into one data frame
all_server_dloads <- bind_rows(preprints_epi_period %>% 
                                  select(source, covid_preprint, doi) %>% 
                                  inner_join(preprint_usage %>% select(doi, pdf_downloads), by = "doi") %>%
                                  select(-doi),
                                ssrn_preprints %>% select(source, covid_preprint, pdf_downloads),
                                ressquare_preprints %>% select(source, covid_preprint, pdf_downloads),
                                dotorg_preprints %>% select(source, covid_preprint, pdf_downloads))

# Generate plot
pS3E <- all_server_dloads %>%
    mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  ggplot(aes(x = source, y = pdf_downloads, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Preprint server", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  ggsave("outputs/figures/partials/Figure_S3E.png", width = 10, height = 5)

# Write figure caption
caption <- str_wrap("Supplementary Figure 3: [tbc]", width = 125)

# Patchwork
pS3A + pS3B + pS3C + pS3D + pS3E +
  plot_layout(nrow = 5) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_S3.png", width = 10, height = 12.5)

```

# Figure 4: Preprint usage and sharing

```{r}

# Prepare data
d <- preprint_citations %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  inner_join(preprints, by = "doi") %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ))

# Panel A: Citations per preprint (COVID vs non-COVID)

p4A <- d %>%
  ggplot(aes(x = covid_preprint, y = citations + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Citations", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4A.png", width = 5, height = 5)

# Panel B: Tweets per preprint (COVID vs non-COVID)

p4B <- d %>%
  ggplot(aes(x = covid_preprint, y = twitter + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Tweets", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4B.png", width = 5, height = 5)

# Panel C: News mentions per preprint (COVID vs non-COVID)

p4C <- d %>%
  ggplot(aes(x = covid_preprint, y = news + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "News Articles", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4C.png", width = 5, height = 5)  

# Panel D: Blog mentions per preprint (COVID vs non-COVID)

p4D <- d %>%
  ggplot(aes(x = covid_preprint, y = blogs + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Blogs", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4D.png", width = 5, height = 5)

# Panels E and F: Correlation plots between Citations, tweets, news articles and blogs

covid_usage <- d %>% 
  filter(covid_preprint == "COVID-19 preprints") %>%
  select(citations, twitter, news, blogs)

non_covid_usage <- d %>% 
  filter(covid_preprint == "non-COVID-19 preprints") %>%
  select(citations, twitter, news, blogs)

covid_corr <- correlate(covid_usage, method = "spearman") %>%
  pivot_longer(citations:blogs) %>%
  rename(rows = rowname,
         cols = name) %>%
  filter(str_trunc(rows, 1, ellipsis = "") < str_trunc(cols, 1, ellipsis = ""))

non_covid_corr <- correlate(non_covid_usage, method = "spearman") %>%
  pivot_longer(citations:blogs) %>%
  rename(rows = rowname,
         cols = name) %>%
  filter(str_trunc(rows, 1, ellipsis = "") < str_trunc(cols, 1, ellipsis = ""))

p4E <- covid_corr %>%
  ggplot(aes(x = rows, y = cols, fill = value)) +
  geom_tile() +
  scale_fill_continuous_sequential(palette = "Reds3", 
                                   breaks = c(0, 0.5, 1), 
                                   limits = c(0, 1)) +
  labs(x = "", y = "", title = "COVID-19 preprints",
       fill = "Spearman Correlation") +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 10)) +
  guides(fill = guide_colourbar(title.position="top", 
                                title.hjust = 0.5,
                                label.position = "bottom",
                                barwidth = 7)) +
  ggsave("outputs/figures/partials/Figure_4E.png", width = 5, height = 5)

p4F <- non_covid_corr %>%
  ggplot(aes(x = rows, y = cols, fill = value)) +
  geom_tile() +
  scale_fill_continuous_sequential(palette = "Reds3", 
                                   breaks = c(0, 0.5, 1), 
                                   limits = c(0, 1)) +
  labs(x = "", y = "", title = "non-COVID-19 preprints",
       fill = "Spearman Correlation") +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 10)) +
  guides(fill = guide_colourbar(title.position="top", 
                                title.hjust = 0.5,
                                label.position = "bottom",
                                barwidth = 7)) +
  ggsave("outputs/figures/partials/Figure_4F.png", width = 5, height = 5)

# Write figure caption
caption <- str_wrap("Figure 4: Comparison of citations, tweets, mentions in news articles and blogs for COVID-19 and non-COVID-19 preprints posted on bioRxiv and medRxiv between January and April 2020. (A) Citations per preprint. (B) Tweets per preprint. (C) News article mentions per preprint. (D) Blog mentions per preprint. (E) Spearman's correlation matrix between all indicators for COVID-19 preprints. (F) Spearman's correlation matrix between all indicators for non-COVID-19 preprints.", width = 125)

# Patchwork

# Manually define layout
layout <- "
ABCD
#EF#
#GH#
"
p <- plot_spacer() + p4A + p4B + plot_spacer() + p4C + p4D + p4E + p4F + 
  plot_layout(design = layout, guides = "collect") & theme(plot.margin = margin(0, 0, 0, 0),
                                                           legend.title = element_text(size = 10),
                                                           legend.position = "bottom")

p +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_4.png", width = 10, height = 10)
  
```

---- Work in progress: Figure 5 and other stuff (still to clean up) -----

# Twitter word cloud

```{r}

library(wordcloud)

preprints <- read_csv("data/preprints_20190901_20200430.csv")
preprint_altmetrics <- read_csv("data/preprint_altmetrics_20190901_20200430.csv")
tweets <- read_csv("data/preprint_tweets_20190901_20200430.csv")

# Get top-10 most tweeted covid-19 preprints
top_preprints <- preprints %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  filter(covid_preprint == T) %>%
  top_n(10, twitter) %>%
  pull(doi)

# Find hashtags associated with top-10 most tweeted covid-19 preprints
hashtags <- tweets %>%
  filter(doi %in% top_preprints) %>%
  select(hashtags) %>%
  na.omit() %>%
  pull(hashtags)

# Expand comma-separated values
hashtags <- str_trim(unlist(strsplit(hashtags, ",")))

# Clean up and generate hashtags frequency table
hashtags_freq <- tibble(hashtags = hashtags) %>%
  mutate(hashtags = str_remove_all(hashtags, "[^a-zA-Z0-9]"), # remove special characters
         hashtags = str_to_lower(hashtags)) %>% # convert all hashtags to lowercase
  filter(!hashtags %in% c("", "covid19", "coronavirus")) %>% # remove empty hashtags and specific keywords
  count(hashtags)

# Generate word cloud and save to png
png("outputs/figures/preprints_top10_hashtags.png", width = 10, height = 10, units = "in", res = 300)
wordcloud(words = hashtags_freq$hashtags, freq = hashtags_freq$n, 
          scale = c(8, 1), min.freq = 10, max.words = 200, 
          random.order = FALSE, rot.per = 0.5, colors = brewer.pal(8, "Dark2"))
dev.off()

```

# Time until publication

```{r}
# Prepare data
# Identify proportion of preprints that are published
preprints_epi_period %>% filter(source == "biorxiv") %>% with(table(covid_preprint, is_published)) %>% prop.table(margin = 1)*100 %>% round(3)
preprints_epi_period %>% filter(source == "medrxiv") %>% with(table(covid_preprint, is_published)) %>% prop.table(margin = 1)*100 %>% round(3)
# Calculate time to publishing
preprints_epi_period %<>% mutate(time_to_publish = as.Date(published_date) - as.Date(posted_date))
preprints_control_period %<>% mutate(time_to_publish = as.Date(published_date) - as.Date(posted_date))
# Identify any preprints published before or at same time as preprint upload
publish_before_preprint <- preprints %>% filter(time_to_publish <= 0)
# Identify publishers with at least 10 published preprints across entire dataset
publisher_list <- preprints_epi_period %>% 
  filter(!is.na(published_publisher) & published_publisher!= "American Chemical Society (ACS)") %>%     # remove ACS as no COVID-19 preprints
  group_by(published_publisher) %>% 
  filter(n() > 10) %>%
  pull(published_publisher) %>%
  unique()
# Plot simple bar of proportion published
p5E <- preprints_epi_period %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
  ) %>% 
  group_by(covid_preprint) %>%
  count(is_published) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(is_published == TRUE) %>%
  ggplot(aes(x=covid_preprint, y=prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(stat = "identity", position="identity") +
  ylab("Percentage of preprints published") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.title.x = element_blank()) +
  guides(fill = FALSE, colour = FALSE) +
  ggsave("outputs/figures/partials/preprint_publishing_percent.png", width = 4, height = 4)
# Plot simple bar of proportion published by server
pS5F <- preprints_epi_period %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
  ) %>% 
  group_by(covid_preprint, source) %>%
  count(is_published) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(is_published == TRUE) %>%
  ggplot(aes(x=source, y=prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(stat = "identity", position="dodge") +
  xlab("Server") +
  ylab("Percentage of preprints published") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_percent_server.png", width = 6, height = 4)
# Plot custom histogram of time to publishing for COVID-19/non-COVID-19 preprints by period
p5D <- bind_rows(preprints_epi_period %>% 
                   mutate(covid_preprint = case_when(
                     covid_preprint == T ~ "COVID-19 preprints",
                     covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
                   ),
                 preprints_control_period %>% 
                   mutate(covid_preprint = "non-COVID-19 preprints\nSep - Dec")
) %>%
  filter(time_to_publish > 0|is.na(time_to_publish)) %>%
  mutate(pub_bracket = cut(as.numeric(time_to_publish), seq(0,240,by=10), labels=seq(0,230,by=10))) %>%
  group_by(covid_preprint) %>%
  count(pub_bracket) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(!is.na(pub_bracket)) %>%
  ggplot(aes(x=pub_bracket, y=prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(alpha=0.2, width=1, stat = "identity", position="identity") +
  scale_x_discrete(labels=c("0","","","","","50","","","","","100","","","","","150","","","","","200","","","")) +
  #  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  xlab("Time from preprint posting to publication (days)") +
  ylab("Percentage of all preprints") +
  scale_color_manual(values = qualitative_hcl(3, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(3, palette = "Set2")) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_time.png", width = 10, height = 6)
p5D <- bind_rows(preprints_epi_period %>% 
                   mutate(covid_preprint = case_when(
                     covid_preprint == T ~ "COVID-19 preprints",
                     covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
                   ),
                 preprints_control_period %>% 
                   mutate(covid_preprint = "non-COVID-19 preprints\nSep - Dec")
) %>%
  filter(time_to_publish > 0|is.na(time_to_publish)) %>%
  count(covid_preprint, time_to_publish) %>%
  complete(time_to_publish, nesting(covid_preprint), fill = list(n = 0)) %>%
  group_by(covid_preprint) %>%
  arrange(time_to_publish) %>%
  mutate(cumulative_prop = cumsum(n)*100/sum(n)) %>%
  ggplot(aes(x = time_to_publish, y = cumulative_prop, fill = covid_preprint)) +
  geom_area(color = "#ffffff", size = 0.5, position = "identity", alpha = 0.2) +
  scale_y_continuous(limits = c(0,21)) +
  #  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  xlab("Time from preprint posting to publication (days)") +
  ylab("Cumulative percentage of all preprints") +
  scale_color_manual(values = qualitative_hcl(3, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(3, palette = "Set2")) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_time_cum.png", width = 10, height = 6)
# Plot boxes of time to publishing for COVID-19/non-COVID-19 preprints by publisher
pS5E <- preprints_epi_period %>% 
  filter(time_to_publish > 0 & published_publisher %in% publisher_list) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints"),
    published_publisher = case_when(
      published_publisher == "MDPI AG" ~ "MDPI",
      published_publisher == "Oxford University Press (OUP)" ~ "OUP",
      published_publisher == "Elsevier BV" ~ "Elsevier",
      published_publisher == "American Society for Microbiology" ~ "ASM",
      published_publisher == "Public Library of Science (PLoS)" ~ "PLoS",
      published_publisher == "Springer Science and Business Media LLC" ~ "Springer",
      published_publisher == "Wiley" ~ "Wiley")
  ) %>%
  ggplot(aes(x = published_publisher, y = time_to_publish, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Publisher", y = "Time from preprint posting to publication (days)", 
       fill = "", color = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  ggsave("outputs/figures/partials/preprint_publishing_time_publisher.png", width = 12, height = 6)
```

# Science focus of senior author

```{r}
# For each author, select their chronologically latest COVID-19 preprint
preprint_author_last <- preprints %>% 
  filter(covid_preprint == TRUE) %>% 
  arrange(posted_date) %>% 
  group_by(author_corresponding) %>% 
  slice(n())
# For each author, extract the category of their last preprint
preprint_author_last %<>% left_join(preprints_all %>% 
                                      filter(author_corresponding %in% preprint_author_last$author_corresponding & !(doi %in% preprint_author_last$doi)) %>% 
                                      arrange(posted_date) %>% 
                                      group_by(author_corresponding) %>% 
                                      slice(n()),
                                    by = "author_corresponding") %>%
  rename_at(vars(contains(".x")), ~ gsub("\\.x","_covid",.)) %>%
  rename_at(vars(contains(".y")), ~ gsub("\\.y","_previous",.)) %>% 
  mutate(category_covid = tolower(category_covid), category_previous = tolower(category_previous)) %>%
  ungroup
# Append to list of preprints
preprints %<>%
  left_join(preprint_citation_lookup, by = "doi") %>%
  left_join(published_citation_lookup, by = "published_doi") %>% 
  replace_na(list(preprint_citations = 0, published_citations = 0)) %>%
  mutate(total_citations = preprint_citations + published_citations)
# Plot alluvial diagram
p5A <- ggplot(data = preprint_author_last %>% 
                filter(!is.na(category_previous)) %>% 
                select(category_covid, category_previous) %>% 
                plyr::count() %>%
                filter(freq >= 5),
              aes(axis1 = category_previous, axis2 = category_covid, y = freq)) +
  scale_x_discrete(limits = c("Previous", "COVID-19"), expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Preprint categorisation") +
  ylab("Frequency") +
  geom_alluvium(aes(fill=category_previous), reverse=TRUE) +
  geom_stratum(reverse=TRUE) + 
  geom_text(size = 3.2, stat = "stratum", label.strata = TRUE, reverse=TRUE, size=0.8) +
  #  geom_text(aes(label = freq), color="gray50", nudge_x=0.23, stat = "alluvium", reverse = TRUE) +
  geom_text(aes(label = freq), size = 3.2, color="gray30", nudge_x=0.14, stat = "stratum", reverse = TRUE) +
  guides(fill=FALSE) +
  theme_bw() +
  ggsave("outputs/figures/partials/preprint_science_focus.png", width = 8, height = 10)
```
