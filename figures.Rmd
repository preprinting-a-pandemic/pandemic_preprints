---
title: "R Notebook"
---

# Load libraries

```{r}

library(tidyverse)
library(magrittr)
library(lubridate)
library(ggalluvial)
library(ggrepel)
library(patchwork) # for creating nice plot grids
library(colorspace) # color palettes

```

# Theme options

```{r}

# Spruce up the default figure formatting
theme_set(theme_minimal() +
            theme(text = element_text(size = 12),
                  axis.title.x = element_text(size = 12,
                                              margin = margin(10, 0, 5, 0)),
                  axis.title.y = element_text(size = 12,
                                              margin = margin(0, 10, 0, 5)),
                  panel.border = element_rect(color = "#E0E0E0", size = 0.5, fill = NA),
                  plot.margin = margin(10, 10, 10, 10),
                  plot.caption = element_text(size = 12, hjust = 0,
                                              margin = margin(20, 0, 0, 0)),
                  plot.caption.position =  "panel",
                  legend.key.size = unit(0.5, "cm")))

# Make sure axis labels (e.g. months) are in English
Sys.setlocale("LC_ALL", "English")

# Create custom date scale
custom_date_scale <- function(start_date, end_date) {
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d",
               expand = c(0, 0),
               limits = c(ymd(start_date), ymd(end_date)))
}

```

# Load datasets

```{r}

# Dataset of COVID-19 cases and deaths. Data is aggregated from the repository
# maintained by Johns Hopkins (https://github.com/CSSEGISandData/COVID-19)
covid <- read_csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/worldwide-aggregated.csv")

# Main preprint datasets generated here
preprints <- read_csv("data/preprints_full_20190901_20200430.csv")
preprints_epi_period <- preprints %>% filter(posted_date >= "2020-01-01") # Subset preprints by period for ease
preprints_control_period <- preprints %>% filter(posted_date < "2020-01-01")
preprint_usage <- read_csv("data/preprint_usage_20190901_20200430.csv")
preprint_citations <- read_csv("data/preprint_citations_20190901_20200430.csv")
preprint_altmetrics <- read_csv("data/preprint_altmetrics_20190901_20200430.csv")
preprint_timing <- read_csv("data/preprint_earliest_per_country_20200101_20200430.csv")

# Reconstruct dataset of ALL preprints
preprint_1 <- read.csv("data/preprints_basic_20131101_20181231.csv", stringsAsFactors = FALSE)   
preprint_2 <- read.csv("data/preprints_basic_20190101_20200430.csv", stringsAsFactors = FALSE)
preprints_all <- bind_rows(preprint_1, preprint_2)

# Full dataset of preprints from other servers
preprints_other <- read_csv("https://raw.githubusercontent.com/nicholasmfraser/covid19_preprints/master/data/covid19_preprints.csv", col_types = "cccccc")

# Journal articles
journal_articles <- read_csv("data/journal_articles_20200101_20200430.csv")

# Load previous citation counts fetched?
load_prev_citations <- TRUE

```

# Figure 1: Development of COVID-19, journal articles and preprints over time

```{r}

# Panel A: Development of COVID-19 cases and deaths

# Define text and coordinates for annotations
text_1 <- "WHO declares COVID-19 \n outbreak a Public Health \n Emergency of \n International Concern"
text_2 <- "WHO declares COVID-19 \n outbreak a pandemic"
x_1 <- ymd("2020-01-30")
x_2 <- ymd("2020-03-11")
y_1 <- covid %>% filter(Date == "2020-01-30") %>% pull(Confirmed)
y_2 <- covid %>% filter(Date == "2020-03-11") %>% pull(Confirmed)
line_length <- 1000000
spacing <- 100000

p1A <- covid %>%
  select(Date, Confirmed, Deaths) %>%
  rename(Cases = Confirmed) %>%
  pivot_longer(Cases:Deaths) %>%
  ggplot(aes(x = Date, y = value, color = name)) +
  geom_line(size = 1) +
  geom_point(size = 1, shape = 21, fill = "white", stroke = 1) +
  annotate("text", x = x_1, y = y_1 + line_length + spacing, 
           label = text_1, vjust = 0, size = 3) +
  annotate("segment", x = x_1, xend = x_1,
           y = y_1 + line_length, yend = y_1 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  annotate("text", x = x_2, y = y_2 + line_length + spacing, 
           label = text_2, vjust = 0, size = 3) +
  annotate("segment", x = x_2, xend = x_2,
           y = y_2 + line_length, yend = y_2 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  labs(x = "", y = "Confirmed Cases / Deaths", color = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1A.png", width = 12, height = 6)

# Panel B: Number of journal articles and preprints on COVID-19

p1B <- preprints_other %>%
  mutate(posted_date = as.Date(posted_date),
         type = "Preprints") %>%
  bind_rows(journal_articles %>% 
            mutate(posted_date = created,
                   type = "Journal Articles")) %>%
  count(type, posted_date) %>%
  complete(posted_date, nesting(type), fill = list(n = 0)) %>%
  group_by(type) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = reorder(type, -total_n)), 
            color = "grey50", size = 0.5) +
  labs(x = "", y = "Articles / Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1B.png", width = 12, height = 6)

# Panel C: Preprints on COVID-19 from multiple sources

# Find the repositories that have > X preprints
n_min <- 100
other <- preprints_other %>%
  count(source) %>%
  filter(n < n_min) %>%
  pull(source)

# Define the levels for facetting (to order sources by publication volume)
fct_levels <- preprints_other %>% 
  mutate(source = case_when(
           source %in% other ~ "Other",
           T ~ source
        )) %>%
  count(source) %>%
  arrange(desc(n)) %>%
  mutate(source = c(source[source != "Other"], "Other")) %>%
  pull(source)

p1C <- preprints_other %>%
  mutate(posted_date = as.Date(posted_date),
         source = case_when(
           source %in% other ~ "Other",
           T ~ source),
        source = factor(source, levels = fct_levels)) %>%
  count(source, posted_date) %>%
  complete(posted_date, nesting(source), fill = list(n = 0)) %>%
  group_by(source) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = source), 
            color = "grey50", size = 0.5) +
  labs(x = "", y = "Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(12, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1C.png", width = 12, height = 6)

# Figure caption
caption <- str_wrap("Figure 1: Development of COVID-19 and publication response between January 2020 and April 2020. (A) Number of COVID-19 confirmed cases and reported deaths. Data from https://github.com/datasets/covid-19/. (B) Cumulative growth of journal articles and preprints containing COVID-19 related search terms. (C) Cumulative growth of preprints containing COVID-19 related search terms, broken down by individual preprint server. Journal data in (B) is based upon data extracted from Dimensions (https://www.dimensions.ai), preprint data in (B) and (C) is based upon data gathered by Fraser and Kramer (2020; https://doi.org/10.6084/m9.figshare.12033672).", width = 120)

# Patchwork
p1A + p1B + p1C + plot_layout(ncol = 1) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/Figure_1.png", width = 10, height = 10)

```

# Supplementary Figure 1: Number of preprints in relation to previous epidemics (Zika, Ebola)

```{r}

# Build search strings containing terms related to other epidemics
search_string_ebola <- "ebola|ZEBOV"
search_string_zika <- "zika|ZIKV"

# Set dates of all epidemics
covid_start <- "2020-01-01"
covid_end <- "2020-04-30"

ebola_start <- "2014-01-24"
ebola_end <- "2016-06-09"  # Outbreak declared ended: https://apps.who.int/iris/bitstream/handle/10665/208883/ebolasitrep_10Jun2016_eng.pdf

zika_start <- "2015-03-02"
zika_end <- "2016-11-18"  # Public health emergency declared ended: https://www.who.int/en/news-room/detail/18-11-2016-fifth-meeting-of-the-emergency-committee-under-the-international-health-regulations-(2005)-regarding-microcephaly-other-neurological-disorders-and-zika-virus

# Determine preprint counts of previous epidemics
covid_counts <- preprints %>% 
                  filter(posted_date >= covid_start) %>% 
                  rename(epi_preprint = covid_preprint) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "COVID-19")

ebola_counts <- preprints_all %>% 
                  filter(posted_date >= ebola_start & posted_date <= ebola_end) %>%
                  mutate(epi_preprint = case_when(
                    str_detect(title, regex(search_string_ebola, ignore_case = TRUE)) ~ T, 
                    str_detect(abstract, regex(search_string_ebola, ignore_case = TRUE)) ~ T,
                    T ~ F)) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "Zaire ebolavirus")

zika_counts <- preprints_all %>% 
                  filter(posted_date >= zika_start & posted_date <= zika_end) %>%
                  mutate(epi_preprint = case_when(
                    str_detect(title, regex(search_string_zika, ignore_case = TRUE)) ~ T, 
                    str_detect(abstract, regex(search_string_zika, ignore_case = TRUE)) ~ T,
                    T ~ F)) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "Zika virus")

# Generate plot
pS1 <- bind_rows(covid_counts, ebola_counts, zika_counts) %>% 
  mutate(epi_preprint = case_when(
      epi_preprint == T ~ "Epidemic-related preprints",
      epi_preprint == F ~ "Non-epidemic preprints"),
    epidemic = factor(epidemic, levels=c("Zaire ebolavirus", "Zika virus", "COVID-19"))) %>%
  ggplot(aes(x = epi_preprint, y = n, colour = epi_preprint, fill = epi_preprint)) +
  geom_bar(stat = "identity") +
  labs(x = "Epidemic", y = "Total preprints", fill = "", color = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  facet_wrap(epidemic ~ ., strip.position = "bottom") +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank()) +
  ggsave("outputs/figures/Figure_S1.png", width = 10, height = 5)

```

# Figure 2: Preprint attributes

```{r}

# Panel A: Numbers of COVID vs non-COVID preprints
# Limit to preprints posted between January and April 2020

p1 <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  count(covid_preprint, posted_week) %>%
  complete(posted_week, nesting(covid_preprint), fill = list(n = 0)) %>%
  ggplot(aes(x = posted_week, y = n, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Posted date (week beginning)", y = "Preprints deposited", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/covid_non_covid_preprints.png", width = 12, height = 6)

# Panel B: Countries depositing COVID/non-COVID preprints (top X)
# Limit to preprints posted between January and April 2020

top_countries <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(institution_match_country_code) %>%
  na.omit() %>%
  # select the number of countries to display
  top_n(10, n) %>%
  arrange(desc(n)) %>%
  pull(institution_match_country_code)

p2 <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  
  count(covid_preprint, institution_match_country_code) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  filter(institution_match_country_code %in% top_countries) %>%
  mutate(institution_match_country_code = factor(institution_match_country_code, 
                                                 levels = top_countries),
    covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = institution_match_country_code, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "", y = "% of corresponding authors", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  ggsave("outputs/figures/partials/covid_non_covid_countries.png", width = 12, height = 6)

# Panel C: First case -> first preprint by location

# Pick countries we want to label (prevent overcrowding)
label_countries <- c("US", "CN", "FR", "DE", "UK")

p3 <- preprint_timing %>%
  mutate(continent = countrycode::countrycode(institution_match_country_code, 
                                              origin = 'iso2c', destination = 'continent')) %>% 
  filter(!is.na(first_preprint) & !is.na(first_case) & !is.na(continent)) %>%
  ggplot(aes(x = first_case, y = first_preprint, label = institution_match_country_code)) +
  geom_point(aes(color = continent), size=2) +
  geom_text_repel(force = 5,
                  segment.color = "grey50",
                  segment.size = 0.2,
                  segment.alpha = 0.8,
                  color = "grey25", 
                  size = 2.5) +
  geom_abline(intercept = 0, slope = 1, color = "grey50", lty = "dashed", alpha = 0.5) +
  labs(x = "Date of first case",
       y = "Date of first preprint",
       color = "") +
  scale_color_manual(values = qualitative_hcl(5, palette = "Set2")) +
  coord_cartesian(ylim = c(ymd("2020-01-01", "2020-04-30")),
                  xlim = c(ymd("2020-01-01", "2020-04-30"))) +
  theme(legend.margin = margin(0, 0, 0, 0)) +
  ggsave("outputs/figures/partials/preprint_case_to_preprint_scatter.png", width = 12, height = 12)

# Panel D: Word counts (placeholder)
p4 <- ggplot(data.frame()) + 
  geom_point() + 
  xlim(0, 1) + ylim(0, 1) + 
  annotate("text", x = 0.5, y = 0.5, label = "Placeholder [Word Counts]")

# Panel E: Author numbers

p5 <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(n_authors = map_int(authors, ~(length(str_split(., ";")[[1]])))) %>%
  count(covid_preprint, n_authors) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  filter(n_authors <= 25) %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = n_authors, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Number of authors", y = "% of preprints", fill = "") +
  scale_x_continuous(breaks = seq(1:30)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(legend.position = "bottom") +
  ggsave("outputs/figures/partials/covid_non_covid_author_counts.png", width = 12, height = 6)

# Panel F: Revisions per preprint for COVID vs non-COVID

p6 <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(covid_preprint, n_versions) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = n_versions, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Number of versions", y = "% of preprints", fill = "") +
  scale_x_continuous(breaks = seq(1:10)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(legend.position = "bottom") +
  ggsave("outputs/figures/partials/covid_non_covid_versions.png", width = 12, height = 6)

# Panel G: Preprints per senior authors

p7 <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(author_corresponding, covid_preprint) %>%
  count(n, covid_preprint) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (nn/sum(nn) * 100)) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  ggplot(aes(x = n, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Number of preprints", y = "% of corresponding authors", fill = "") +
  scale_x_continuous(breaks = seq(1:12)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  ggsave("outputs/figures/partials/covid_non_covid_preprints_per_author.png", width = 12, height = 6)

# Figure caption
caption <- str_wrap("Figure 2: Attributes of COVID-19 and non-COVID-19 preprints deposited on bioRxiv and medRxiv between January and April 2020. (A) Number of preprints deposited per week. (B) Percentage of preprints deposited by country of corresponding author. (C) Correlation between date of the first preprint originating from a country (according to the affiliation of the corresponding author) and the date of the first confirmed case from the same country for COVID-19 preprints. (D) [word counts - tbc]. (E) Distribution of the number of authors per preprint. (F) Distribution of the number of deposited preprint versions. (G) Distribution of the number of preprints posted by the same corresponding author.", width = 120)

p <- p1 / (p2 | p3 + plot_layout(guides = "keep")) / (p4 | p5) / (p6 | p7) + 
  plot_layout(guides = "collect") & theme(legend.position = "top")

p + plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/preprint_attributes.png", width = 10, height = 12) 
  
```

# Figure 3: Preprint access

```{r}

# start date for plots
start_date <- "2020-01-01"

# Prepare data
d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  group_by(doi, posted_date, covid_preprint) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  filter(posted_date >= start_date)

# Abstract views
p3A <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.1, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", NA) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/preprint_abstract_views.png", width = 10, height = 5)

# PDF downloads
p3B <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.1, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", NA) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/preprint_pdf_downloads.png", width = 10, height = 7.5)

# Write figure caption
caption <- str_wrap("Figure 3: Distribution of access statistics for COVID-19 and non-COVID-19 preprints posted on bioRxiv and medRxiv. (A) Total abstract views. (B) Total PDF downloads.", width = 125)


# Patchwork
p3A + p3B + plot_layout(ncol = 1) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/preprint_access.png", width = 10, height = 7.5)

# Supplementary Figure: Time prior to our study period

# start date for plots
start_date <- "2019-09-01"

# Prepare data
d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  filter(covid_preprint != T) %>%
  group_by(doi, posted_date) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1)) %>%
  filter(posted_week >= start_date)

# Abstract views
p3SA <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, group = posted_week)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.1) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e5), expand = c(0, 0)) +
  custom_date_scale("2019-09-01", NA) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/preprint_abstract_views_supplementary.png", width = 12, height = 6)

# PDF downloads
p3SB <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, group = posted_week)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.1) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e5), expand = c(0, 0)) +
  custom_date_scale("2019-09-01", NA) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/preprint_pdf_downloads_supplementary.png", width = 12, height = 6)

# Write figure caption
caption <- str_wrap("Supplementary Figure 3: Distribution of access statistics for all preprints posted on bioRxiv and medRxiv between 2019-09-01 and 2020-04-30. (A) Total abstract views. (B) Total PDF downloads.", width = 125)

# Patchwork
p3SA + p3SB + plot_layout(ncol = 1) +
  plot_annotation(caption = caption, tag_levels = "A") +
  ggsave("outputs/figures/preprint_access_supplementary.png", width = 10, height = 5)

# Total downloads of COVID and non-COVID preprints by server

# Build a search string containing terms related to COVID-19
search_string_covid <- "coronavirus|covid-19|sars-cov|ncov-2019|2019-ncov|hcov-19|sars-2"

# Read in and process data from other servers
# SSRN
ssrn_preprints <- read.csv("data/otherservers/ssrn_extract.csv", quote = "", stringsAsFactors = FALSE) %>%
  rename_all(~str_replace_all(.,"\\.|X\\.","")) %>%
  group_by(abstract_id, ab_title) %>%
  summarise(pdf_downloads = sum(total_downloads)) %>%
  mutate(covid_preprint = case_when(
    str_detect(ab_title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
    T ~ F),
    source = "SSRN") %>% 
  ungroup

# Research Square
ressquare_titles <- read.csv("data/otherservers/article_data.csv", stringsAsFactors = FALSE) %>% select(article_identity, title)
ressquare_texts <- read.csv("data/otherservers/full_article_text-002.csv", stringsAsFactors = FALSE) %>% select(article_identity, plain_abstract)
ressquare_preprints <- read.csv("data/otherservers/engagement_by_article_and_date.csv", stringsAsFactors = FALSE) %>%
  left_join(ressquare_titles, by = "article_identity") %>%
  left_join(ressquare_texts, by = "article_identity") %>%
  group_by(article_identity, title, plain_abstract) %>%
  summarise(pdf_downloads = sum(downloads)) %>%
  mutate(covid_preprint = case_when(
    str_detect(title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
    str_detect(plain_abstract, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    T ~ F),
    source = "Research Square") %>% 
  ungroup

# Preprints.org
dotorg_preprints <- read.csv("data/otherservers/2020-01-01-2020-04-30_preprints_dot_org.csv", stringsAsFactors = FALSE) %>%
  rename(pdf_downloads = downloads) %>%
  mutate(covid_preprint = case_when(
    str_detect(title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
    str_detect(abstract, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    T ~ F),
    source = "Preprints.org")

# Bind into one data frame
all_server_dloads <- bind_rows(preprints_epi_period %>% 
                                  select(source, covid_preprint, doi) %>% 
                                  inner_join(preprint_usage %>% select(doi, pdf_downloads), by = "doi") %>%
                                  select(-doi),
                                ssrn_preprints %>% select(source, covid_preprint, pdf_downloads),
                                ressquare_preprints %>% select(source, covid_preprint, pdf_downloads),
                                dotorg_preprints %>% select(source, covid_preprint, pdf_downloads))

pS3C <- all_server_dloads %>%
    mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  ggplot(aes(x = source, y = pdf_downloads, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Server", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  ggsave("outputs/figures/partials/preprint_downloads_by_server.png", width = 12, height = 6)

```

# Figure 4: Preprint usage and sharing

```{r}

# start date for plots
start_date <- "2020-01-01"

# Citations

# Prepare data
d <- preprint_citations %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  inner_join(preprints, by = "doi") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  filter(posted_week >= start_date)

p1 <- d %>%
  ggplot(aes(x = covid_preprint, y = citations + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Citations", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_blank())

p2 <- d %>%
  ggplot(aes(x = covid_preprint, y = twitter + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Tweets", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_blank())

p3 <- d %>%
  ggplot(aes(x = covid_preprint, y = news + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "News Articles", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_blank())

p4 <- d %>%
  ggplot(aes(x = citations + 1, y = twitter + 1)) +
  geom_point(aes(color = covid_preprint), alpha = 0.75, size = 1) +
  labs(x = "Citations", y = "Tweets", color = "") +
  scale_x_log10(labels = scales::comma, expand = c(0, 0.1)) +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2"))

p5 <- d %>%
  ggplot(aes(x = citations + 1, y = news + 1)) +
  geom_point(aes(color = covid_preprint), alpha = 0.75, size = 1) +
  labs(x = "Citations", y = "News Articles", color = "") +
  scale_x_log10(labels = scales::comma, expand = c(0, 0.1)) +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2"))

p6 <- d %>%
  ggplot(aes(x = news + 1, y = twitter + 1)) +
  geom_point(aes(color = covid_preprint), alpha = 0.75, size = 1) +
  labs(x = "News Articles", y = "Tweets", color = "") +
  scale_x_log10(labels = scales::comma, expand = c(0, 0.1)) +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2"))

# Write figure caption
caption <- str_wrap("Figure 4: Comparison of citations, tweets, and mentions in news articles for COVID-19 and non-COVID-19 preprints posted on bioRxiv and medRxiv between January and April 2020. (A) Citations per preprint. (B) Tweets per preprint. (C) News article mentions per preprint. (D) Correlation between tweets and citations. (E) Correlation between mentions in news articles and citations. (F) Correlation between tweets and mentions in news articles", width = 125)

p <- ((p1 | p2 | p3 ) + plot_layout(guides = "collect")) /
     ((p4 | p5 | p6 ) + plot_layout(guides = "collect")) +
     plot_annotation(caption = caption, tag_levels = "A") & theme(plot.margin = margin(0, 5, 0, 5), 
                                                                legend.position = "right")

p + ggsave("outputs/figures/preprint_usage.png", width = 10, height = 5)

```

# Timing of first preprint and first case per country 

```{r}
# Plot timing
p2C <- case_author_dates_df %>% 
  mutate(continent = countrycode::countrycode(institution_match_country_code, origin = 'iso2c', destination = 'continent')) %>% 
  filter(!is.na(first_preprint) & !is.na(first_case)) %>%
  ggplot(aes(x = first_case, y = first_preprint, label = institution_match_country_name)) +
  geom_point(aes(color = continent), size=2) +
  geom_text_repel(size = 3, force = 1.2, segment.size = 0.2) +
  xlab("Date of first confirmed case") +
  ylab('Date of first preprint authorship') +
  geom_abline(intercept = 0, slope = 1, color="grey50", lty="dashed", alpha=0.5) +
  ggsave("outputs/figures/partials/preprint_case_to_preprint_scatter.png", width = 10, height = 8)
# Plot histogram of lag
preprint_timing %>%
  ggplot(aes(x=lag)) +
  geom_histogram(bins=30) +
  scale_x_continuous(breaks=seq(-40, 80, 20), limits = c(-40, 80)) +
  xlab("Days from first case until first preprint") +
  ylab("Frequency") +
  ggsave("outputs/figures/partials/preprint_case_to_preprint_hist.png", width = 10, height = 5)
```

# Time until publication

```{r}
# Prepare data
# Identify proportion of preprints that are published
preprints_epi_period %>% filter(source == "biorxiv") %>% with(table(covid_preprint, is_published)) %>% prop.table(margin = 1)*100 %>% round(3)
preprints_epi_period %>% filter(source == "medrxiv") %>% with(table(covid_preprint, is_published)) %>% prop.table(margin = 1)*100 %>% round(3)
# Calculate time to publishing
preprints_epi_period %<>% mutate(time_to_publish = as.Date(published_date) - as.Date(posted_date))
preprints_control_period %<>% mutate(time_to_publish = as.Date(published_date) - as.Date(posted_date))
# Identify any preprints published before or at same time as preprint upload
publish_before_preprint <- preprints %>% filter(time_to_publish <= 0)
# Identify publishers with at least 10 published preprints across entire dataset
publisher_list <- preprints_epi_period %>% 
  filter(!is.na(published_publisher) & published_publisher!= "American Chemical Society (ACS)") %>%     # remove ACS as no COVID-19 preprints
  group_by(published_publisher) %>% 
  filter(n() > 10) %>%
  pull(published_publisher) %>%
  unique()
# Plot simple bar of proportion published
p5E <- preprints_epi_period %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
  ) %>% 
  group_by(covid_preprint) %>%
  count(is_published) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(is_published == TRUE) %>%
  ggplot(aes(x=covid_preprint, y=prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(stat = "identity", position="identity") +
  ylab("Percentage of preprints published") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  theme(axis.title.x = element_blank()) +
  guides(fill = FALSE, colour = FALSE) +
  ggsave("outputs/figures/partials/preprint_publishing_percent.png", width = 4, height = 4)
# Plot simple bar of proportion published by server
pS5F <- preprints_epi_period %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
  ) %>% 
  group_by(covid_preprint, source) %>%
  count(is_published) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(is_published == TRUE) %>%
  ggplot(aes(x=source, y=prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(stat = "identity", position="dodge") +
  xlab("Server") +
  ylab("Percentage of preprints published") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_percent_server.png", width = 6, height = 4)
# Plot custom histogram of time to publishing for COVID-19/non-COVID-19 preprints by period
p5D <- bind_rows(preprints_epi_period %>% 
                   mutate(covid_preprint = case_when(
                     covid_preprint == T ~ "COVID-19 preprints",
                     covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
                   ),
                 preprints_control_period %>% 
                   mutate(covid_preprint = "non-COVID-19 preprints\nSep - Dec")
) %>%
  filter(time_to_publish > 0|is.na(time_to_publish)) %>%
  mutate(pub_bracket = cut(as.numeric(time_to_publish), seq(0,240,by=10), labels=seq(0,230,by=10))) %>%
  group_by(covid_preprint) %>%
  count(pub_bracket) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(!is.na(pub_bracket)) %>%
  ggplot(aes(x=pub_bracket, y=prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(alpha=0.2, width=1, stat = "identity", position="identity") +
  scale_x_discrete(labels=c("0","","","","","50","","","","","100","","","","","150","","","","","200","","","")) +
  #  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  xlab("Time from preprint posting to publication (days)") +
  ylab("Percentage of all preprints") +
  scale_color_manual(values = c(palette("deep orange"), palette("cyan"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("cyan"), palette("grey"))) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_time.png", width = 10, height = 6)
p5D <- bind_rows(preprints_epi_period %>% 
                   mutate(covid_preprint = case_when(
                     covid_preprint == T ~ "COVID-19 preprints",
                     covid_preprint == F ~ "non-COVID-19 preprints\nJan - Apr")
                   ),
                 preprints_control_period %>% 
                   mutate(covid_preprint = "non-COVID-19 preprints\nSep - Dec")
) %>%
  filter(time_to_publish > 0|is.na(time_to_publish)) %>%
  count(covid_preprint, time_to_publish) %>%
  complete(time_to_publish, nesting(covid_preprint), fill = list(n = 0)) %>%
  group_by(covid_preprint) %>%
  arrange(time_to_publish) %>%
  mutate(cumulative_prop = cumsum(n)*100/sum(n)) %>%
  ggplot(aes(x = time_to_publish, y = cumulative_prop, fill = covid_preprint)) +
  geom_area(color = "#ffffff", size = 0.5, position = "identity", alpha = 0.2) +
  scale_y_continuous(limits = c(0,21)) +
  #  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  xlab("Time from preprint posting to publication (days)") +
  ylab("Cumulative percentage of all preprints") +
  scale_color_manual(values = c(palette("deep orange"), palette("cyan"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("cyan"), palette("grey"))) +
  theme(legend.title = element_blank()) +
  ggsave("outputs/figures/partials/preprint_publishing_time_cum.png", width = 10, height = 6)
# Plot boxes of time to publishing for COVID-19/non-COVID-19 preprints by publisher
pS5E <- preprints_epi_period %>% 
  filter(time_to_publish > 0 & published_publisher %in% publisher_list) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints"),
    published_publisher = case_when(
      published_publisher == "MDPI AG" ~ "MDPI",
      published_publisher == "Oxford University Press (OUP)" ~ "OUP",
      published_publisher == "Elsevier BV" ~ "Elsevier",
      published_publisher == "American Society for Microbiology" ~ "ASM",
      published_publisher == "Public Library of Science (PLoS)" ~ "PLoS",
      published_publisher == "Springer Science and Business Media LLC" ~ "Springer",
      published_publisher == "Wiley" ~ "Wiley")
  ) %>%
  ggplot(aes(x = published_publisher, y = time_to_publish, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Publisher", y = "Time from preprint posting to publication (days)", 
       fill = "", color = "") +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  ggsave("outputs/figures/partials/preprint_publishing_time_publisher.png", width = 12, height = 6)
```

# Citation counts
```{r}
# Prepare data
# Extract citation counts for all preprint and published dois using CrossRef API
if (load_prev_citations == TRUE){
  load(file="data\\citations.RData")
} else {
  preprint_citation_lookup <- preprints %>% pull(doi) %>% cr_citation_count %>% rename(preprint_citations = count)
  published_citation_lookup <- preprints %>% filter(!is.na(published_doi)) %>% pull(published_doi) %>% cr_citation_count %>% rename(published_citations = count, published_doi = doi)
  save(preprint_citation_lookup, published_citation_lookup, file="data\\citations.RData")
}
# Append to list of preprints
preprints %<>%
  left_join(preprint_citation_lookup, by = "doi") %>%
  left_join(published_citation_lookup, by = "published_doi") %>% 
  replace_na(list(preprint_citations = 0, published_citations = 0)) %>%
  mutate(total_citations = preprint_citations + published_citations)
# Plot total citations 
p3D <- preprints %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints")
  ) %>%
  ggplot(aes(x = covid_preprint, y = total_citations, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "", y = "Citations (log scale)", 
       fill = "", color = "") +
  scale_y_continuous(trans='log10') +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/preprint_citations_total.png", width = 5, height = 6)
# Plot individual preprint/published citations 
preprints %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19",
    covid_preprint == F ~ "non-COVID-19")
  ) %>% select(doi, covid_preprint, source, preprint_citations, published_citations) %>%
  gather(type, count, -doi, -covid_preprint, -source) %>%
  mutate(type = case_when(
    type == "preprint_citations" ~ "Preprint",
    type == "published_citations" ~ "Publication")) %>%
  ggplot(aes(x = type, y = count, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 1, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Article version", y = "Citations (log scale)", 
       fill = "", color = "") +
  scale_y_continuous(trans='log10') +
  scale_color_manual(values = c(palette("deep orange"), palette("grey"))) +
  scale_fill_manual(values = c(palette("deep orange"), palette("grey"))) +
  facet_wrap(source ~ ., nrow = 2, strip.position = "right") +
  ggsave("outputs/figures/partials/preprint_citations_split.png", width = 10, height = 8)
```

# Science focus of senior author
```{r}
# For each author, select their chronologically latest COVID-19 preprint
preprint_author_last <- preprints %>% 
  filter(covid_preprint == TRUE) %>% 
  arrange(posted_date) %>% 
  group_by(author_corresponding) %>% 
  slice(n())
# For each author, extract the category of their last preprint
preprint_author_last %<>% left_join(preprints_all %>% 
                                      filter(author_corresponding %in% preprint_author_last$author_corresponding & !(doi %in% preprint_author_last$doi)) %>% 
                                      arrange(posted_date) %>% 
                                      group_by(author_corresponding) %>% 
                                      slice(n()),
                                    by = "author_corresponding") %>%
  rename_at(vars(contains(".x")), ~ gsub("\\.x","_covid",.)) %>%
  rename_at(vars(contains(".y")), ~ gsub("\\.y","_previous",.)) %>% 
  mutate(category_covid = tolower(category_covid), category_previous = tolower(category_previous)) %>%
  ungroup
# Append to list of preprints
preprints %<>%
  left_join(preprint_citation_lookup, by = "doi") %>%
  left_join(published_citation_lookup, by = "published_doi") %>% 
  replace_na(list(preprint_citations = 0, published_citations = 0)) %>%
  mutate(total_citations = preprint_citations + published_citations)
# Plot alluvial diagram
p5A <- ggplot(data = preprint_author_last %>% 
                filter(!is.na(category_previous)) %>% 
                select(category_covid, category_previous) %>% 
                plyr::count() %>%
                filter(freq >= 5),
              aes(axis1 = category_previous, axis2 = category_covid, y = freq)) +
  scale_x_discrete(limits = c("Previous", "COVID-19"), expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Preprint categorisation") +
  ylab("Frequency") +
  geom_alluvium(aes(fill=category_previous), reverse=TRUE) +
  geom_stratum(reverse=TRUE) + 
  geom_text(size = 3.2, stat = "stratum", label.strata = TRUE, reverse=TRUE, size=0.8) +
  #  geom_text(aes(label = freq), color="gray50", nudge_x=0.23, stat = "alluvium", reverse = TRUE) +
  geom_text(aes(label = freq), size = 3.2, color="gray30", nudge_x=0.14, stat = "stratum", reverse = TRUE) +
  guides(fill=FALSE) +
  theme_bw() +
  ggsave("outputs/figures/partials/preprint_science_focus.png", width = 8, height = 10)
```
