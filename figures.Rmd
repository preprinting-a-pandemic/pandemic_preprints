---
title: "R Notebook"
---

# Load libraries

```{r}

library(tidyverse)
library(magrittr)
library(lubridate)
library(ggalluvial)
library(ggrepel)
library(corrr) # for correlation matrix
library(patchwork) # for creating nice plot grids
library(colorspace) # better color palettes

```

# Theme options

```{r}

# Spruce up the default figure formatting
theme_set(theme_minimal() +
            theme(text = element_text(size = 12),
                  axis.title.x = element_text(size = 12,
                                              margin = margin(10, 0, 5, 0)),
                  axis.title.y = element_text(size = 12,
                                              margin = margin(0, 10, 0, 5)),
                  plot.title = element_text(size = 12),
                  panel.border = element_rect(color = "#E0E0E0", size = 0.5, fill = NA),
                  plot.margin = margin(5, 5, 5, 5),
                  plot.caption = element_text(size = 12, hjust = 0,
                                              margin = margin(20, 0, 0, 0)),
                  plot.caption.position =  "panel",
                  legend.key.size = unit(0.5, "cm")))

# Make sure axis labels (e.g. month names) are in English
Sys.setlocale("LC_ALL", "English")

# Create custom date scale for time-series plots
custom_date_scale <- function(start_date, end_date) {
  scale_x_date(date_breaks = "1 week",
               date_minor_breaks = "1 day",
               date_labels = "%b %d",
               expand = c(0, 0),
               limits = c(ymd(start_date), ymd(end_date)))
}

```

# Load datasets

```{r}

# Dataset of COVID-19 cases and deaths. Data is aggregated from the repository
# maintained by Johns Hopkins (https://github.com/CSSEGISandData/COVID-19)
covid <- read_csv("https://raw.githubusercontent.com/datasets/covid-19/master/data/worldwide-aggregated.csv")

# Full dataset of preprints from the launch of bioRxiv (Nov 2013) to the end of
# our study period (April 2020). Due to GitHub size limitations, data is split
# between two files which must be subsequently bound together
preprint_1 <- read.csv("data/preprints_basic_20131101_20181231.csv", stringsAsFactors = FALSE)   
preprint_2 <- read.csv("data/preprints_basic_20190101_20200430.csv", stringsAsFactors = FALSE)
preprints_all <- bind_rows(preprint_1, preprint_2)
rm(preprint_1, preprint_2)

# More detailed preprint metadata covering period Sept 2019 - April 2020
preprints <- read_csv("data/preprints_full_20190901_20200430.csv",
                      col_types = cols(n_refs = "n", n_words = "n"))

# Subset preprint dataset above by period for ease
preprints_epi_period <- preprints %>% filter(posted_date >= "2020-01-01") 
preprints_control_period <- preprints %>% filter(posted_date < "2020-01-01")

# Preprint usage data (PDF downloads, abstract views)
preprint_usage <- read_csv("data/preprint_usage_20190901_20200430.csv")

# Preprint citation data
preprint_citations <- read_csv("data/preprint_citations_20190901_20200430.csv")

# Preprint altmetrics data
preprint_altmetrics <- read_csv("data/preprint_altmetrics_20190901_20200430.csv")

# Data of preprint timing (i.e. timing of first preprint per country - see Figure 2)
preprint_timing <- read_csv("data/preprint_earliest_per_country_20200101_20200430.csv")

# Preprint comments (counts) data
preprint_comments <- read_csv("data/preprint_comments_20190901_20200430.csv")

# Preprint policies
preprint_policy <- read.csv("data\\preprint_policy_20190901_20200430.csv")

# Changes between preprints and their published papers
preprint_changes <- read_csv("data/preprint_article_changes.csv")

# Full dataset of preprints from other servers (note: dataset is generated
# externally and updated weekly)
preprints_other <- read_csv("https://raw.githubusercontent.com/nicholasmfraser/covid19_preprints/master/data/covid19_preprints.csv", col_types = "cccccc")

# Dataset of journal articles on COVID-19 from Dimensions. Dataset covers the 
# period Jan - May 2020, but for figures we only include data until April 2020
journal_articles <- read_csv("data/journal_articles_20200101_20200531.csv") %>%
  filter(published_date <= as.Date("2020-04-30"))

```

# Figure 1: Development of COVID-19, journal articles and preprints over time

```{r}

# Panel A: Development of COVID-19 cases and deaths

# Define text and coordinates for annotations
text_1 <- "WHO declares COVID-19 \n outbreak a Public Health \n Emergency of \n International Concern"
text_2 <- "WHO declares COVID-19 \n outbreak a pandemic"
x_1 <- ymd("2020-01-30")
x_2 <- ymd("2020-03-11")
y_1 <- covid %>% filter(Date == "2020-01-30") %>% pull(Confirmed)
y_2 <- covid %>% filter(Date == "2020-03-11") %>% pull(Confirmed)
line_length <- 1000000
spacing <- 100000

p1A <- covid %>%
  filter(Date <= "2020-04-30") %>%
  select(Date, Confirmed, Deaths) %>%
  rename(Cases = Confirmed) %>%
  pivot_longer(Cases:Deaths) %>%
  ggplot(aes(x = Date, y = value, color = name)) +
  geom_line(size = 1) +
  geom_point(size = 1, shape = 21, fill = "white", stroke = 1) +
  annotate("text", x = x_1, y = y_1 + line_length + spacing, 
           label = text_1, vjust = 0, size = 3) +
  annotate("segment", x = x_1, xend = x_1,
           y = y_1 + line_length, yend = y_1 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  annotate("text", x = x_2, y = y_2 + line_length + spacing, 
           label = text_2, vjust = 0, size = 3) +
  annotate("segment", x = x_2, xend = x_2,
           y = y_2 + line_length, yend = y_2 + spacing,
           arrow = arrow(length = unit(0.2, "cm")), size = 0.5, 
           lineend = "round", linejoin = "round") +
  labs(x = "", y = "Confirmed Cases / Deaths", color = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1A.png", width = 10, height = 4)

# Panel B: Number of journal articles and preprints on COVID-19

p1B <- preprints_other %>%
  mutate(posted_date = as.Date(posted_date), type = "Preprints") %>%
  bind_rows(journal_articles %>% mutate(posted_date = created,
                                        type = "Journal Articles")) %>%
  count(type, posted_date) %>%
  complete(posted_date, nesting(type), fill = list(n = 0)) %>%
  group_by(type) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = reorder(type, -total_n)), 
            color = "grey50", size = 0.5) +
  labs(x = "", y = "Articles / Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1B.png", width = 10, height = 4)

# Panel C: Preprints on COVID-19 from multiple sources

# Find the repositories that have > X preprints
n_min <- 50
other <- preprints_other %>%
  filter(posted_date <= "2020-04-30") %>%
  count(source) %>%
  filter(n < n_min) %>%
  pull(source)

# Define the levels for facetting (to order sources by publication volume)
fct_levels <- preprints_other %>% 
  mutate(source = case_when(
           source %in% other ~ "Other",
           T ~ source
        )) %>%
  count(source) %>%
  arrange(desc(n)) %>%
  mutate(source = c(source[source != "Other"], "Other")) %>%
  pull(source)

p1C <- preprints_other %>%
  mutate(posted_date = as.Date(posted_date),
         source = case_when(
           source %in% other ~ "Other",
           T ~ source),
        source = factor(source, levels = fct_levels)) %>%
  count(source, posted_date) %>%
  complete(posted_date, nesting(source), fill = list(n = 0)) %>%
  group_by(source) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ggplot() +
  geom_area(aes(x = posted_date, y = cumulative_n, fill = source), 
            color = "grey50", size = 0.5) +
  labs(x = "", y = "Preprints", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_fill_manual(values = qualitative_hcl(12, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_1C.png", width = 10, height = 4)

# Patchwork
p1A + p1B + p1C + p1D + plot_layout(ncol = 1, heights = c(1,1,1,1.5)) +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_1.png", width = 10, height = 12)

```

# Supplementary Figure 1: Number of preprints in relation to previous epidemics (Zika, Ebola)

```{r}

# Build search strings containing terms related to other epidemics
search_string_ebola <- "ebola|ZEBOV"
search_string_zika <- "zika|ZIKV"

# Set dates of all epidemics
covid_start <- "2020-01-01"
covid_end <- "2020-04-30"

ebola_start <- "2014-01-24"
ebola_end <- "2016-06-09"  # Outbreak declared ended: https://apps.who.int/iris/bitstream/handle/10665/208883/ebolasitrep_10Jun2016_eng.pdf

zika_start <- "2015-03-02"
zika_end <- "2016-11-18"  # Public health emergency declared ended: https://www.who.int/en/news-room/detail/18-11-2016-fifth-meeting-of-the-emergency-committee-under-the-international-health-regulations-(2005)-regarding-microcephaly-other-neurological-disorders-and-zika-virus

# Determine preprint counts of previous epidemics
covid_counts <- preprints %>% 
                  filter(posted_date >= covid_start) %>% 
                  rename(epi_preprint = covid_preprint) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "COVID-19")

ebola_counts <- preprints_all %>% 
                  filter(posted_date >= ebola_start & posted_date <= ebola_end) %>%
                  mutate(epi_preprint = case_when(
                    str_detect(title, regex(search_string_ebola, ignore_case = TRUE)) ~ T, 
                    str_detect(abstract, regex(search_string_ebola, ignore_case = TRUE)) ~ T,
                    T ~ F)) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "Western Africa Ebola virus")

zika_counts <- preprints_all %>% 
                  filter(posted_date >= zika_start & posted_date <= zika_end) %>%
                  mutate(epi_preprint = case_when(
                    str_detect(title, regex(search_string_zika, ignore_case = TRUE)) ~ T, 
                    str_detect(abstract, regex(search_string_zika, ignore_case = TRUE)) ~ T,
                    T ~ F)) %>% 
                  count(epi_preprint) %>%
                  mutate(epidemic = "Zika virus")
# Generate plot
pS1A <- bind_rows(covid_counts, ebola_counts, zika_counts) %>% 
  mutate(epi_preprint = case_when(
      epi_preprint == T ~ "Epidemic-related preprints",
      epi_preprint == F ~ "Non-epidemic preprints"),
    epidemic = factor(epidemic, levels=c("Western Africa Ebola virus", "Zika virus", "COVID-19"))) %>%
  ggplot(aes(x = epi_preprint, y = n, colour = epi_preprint, fill = epi_preprint)) +
  geom_col(color = "grey50", size = 0.25) +
  labs(x = "", y = "Total preprints", fill = "", color = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  facet_wrap(epidemic ~ ., strip.position = "bottom") +
  theme(axis.text.x = element_blank(),
        plot.margin = margin(0, 0, 20, 0)) +
  ggsave("outputs/figures/partials/Figure_S1A.png", width = 10, height = 4)

pS1B <-journal_articles %>% 
  count(article_is_oa, created) %>%
  complete(created, nesting(article_is_oa), fill = list(n = 0)) %>%
  group_by(article_is_oa) %>%
  mutate(cumulative_n = cumsum(n),
         total_n = sum(n)) %>%
  ungroup() %>%
  mutate(article_is_oa = case_when(
      article_is_oa == T ~ "Open Access",
      T  ~ "Closed Access")) %>%
  ggplot() +
  geom_area(aes(x = created, y = cumulative_n, fill = reorder(article_is_oa, -total_n)), 
            color = "grey50", size = 0.25) +
  labs(x = "", y = "Journal Articles", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_fill_manual(values = c(qualitative_hcl(n = 4, palette = "Set2")[4], "grey40")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S1B.png", width = 10, height = 4)

pS1A + pS1B + plot_layout(ncol = 1) +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_S1.png", width = 10, height = 6)

```

# Figure 2: Preprint attributes

```{r}

# Panel A: Numbers of COVID vs non-COVID preprints
# Limit to preprints posted between January and April 2020

p2A <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  count(covid_preprint, posted_week) %>%
  complete(posted_week, nesting(covid_preprint), fill = list(n = 0)) %>%
  ggplot(aes(x = posted_week, y = n, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single"), width = 6, size = 0.25) +
  labs(x = "Posted date (week beginning)", y = "Preprints deposited", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_2A.png", width = 10, height = 4)

# Panel B: Preprint screening time

p2B <- preprints %>%
  filter(posted_date >= "2020-01-01")  %>%
  mutate(doi_date = gsub("\\.", "-", substr(doi, 9, 18)),
         days = as.numeric(ymd(posted_date) - ymd(doi_date)),
         days = case_when(
           days > 7 ~ "8+",
           T ~ as.character(days)),
         days = factor(days,
                       levels = c("0", "1", "2", "3", "4", "5", "6", "7", "8+"),
                       labels = c("0", "1", "2", "3", "4", "5", "6", "7", "8+"))
  ) %>%
  count(covid_preprint, days) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  ggplot(aes(x = days, y = proportion,  fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single"), width = 0.75, size = 0.25) +    
  labs(x = "Screening time (days)", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2B.png", width = 5, height = 4)

# Panel C: Countries depositing COVID/non-COVID preprints (top 10)
# Limit to preprints posted between January and April 2020

top_countries <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(institution_match_country_code) %>%
  na.omit() %>%
  # select the number of countries to display
  top_n(10, n) %>%
  arrange(desc(n)) %>%
  pull(institution_match_country_code)

p2C <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  
  count(covid_preprint, institution_match_country_code) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  filter(institution_match_country_code %in% top_countries) %>%
  mutate(institution_match_country_code = factor(institution_match_country_code, 
                                                 levels = top_countries),
    covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = institution_match_country_code, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single"), width = 0.75, size = 0.25) +
  labs(x = "Country of corresponding author", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2C.png", width = 5, height = 4)

# Panel D: First case -> first preprint by location

p2D <- preprint_timing %>%
  mutate(continent = countrycode::countrycode(institution_match_country_code, 
                                              origin = 'iso2c', destination = 'continent')) %>% 
  filter(!is.na(first_preprint) & !is.na(first_case) & !is.na(continent)) %>%
  ggplot(aes(x = first_case, y = first_preprint, label = institution_match_country_code)) +
  geom_point(aes(color = continent), size=2) +
  geom_text_repel(force = 5,
                  segment.color = "grey50",
                  segment.size = 0.2,
                  segment.alpha = 0.8,
                  color = "grey25", 
                  size = 2.5) +
  geom_abline(intercept = 0, slope = 1, color = "grey50", lty = "dashed", alpha = 0.5) +
  labs(x = "Date of first case",
       y = "Date of first preprint",
       color = "") +
  scale_color_manual(values = qualitative_hcl(5, palette = "Set2")) +
  coord_cartesian(ylim = c(ymd("2020-01-01", "2020-04-30")),
                  xlim = c(ymd("2020-01-01", "2020-04-30"))) +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_2D.png", width = 5, height = 4)

# Panel E: Author counts

p2E <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(n_authors = map_dbl(authors, ~(length(str_split(., ";")[[1]]))),
         n_authors = case_when(
           n_authors > 10 ~ "11+",
           T ~ as.character(n_authors)),
           n_authors = factor(n_authors,
                              levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11+"),
                              labels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11+"))
  ) %>%
  count(covid_preprint, n_authors) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = n_authors, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single"), width = 0.75, size = 0.25) +
  labs(x = "Number of authors", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2E.png", width = 5, height = 4)

# Panel F: License types

p2F <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(license = case_when(
    str_detect(license, "cc0") ~ "cc0",
    T ~ license
  )) %>%
  count(covid_preprint, license) %>%
  na.omit() %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    ),
    license = factor(license,
                     levels = c("cc0", "cc_by", "cc_by_nc", "cc_by_nd", "cc_by_nc_nd", "cc_no", "cc0_ng"),
                     labels = c("CC0", "CC BY", "CC BY-NC", "CC BY-ND", "CC BY-NC-ND", "No License", "CC0 NG?"))) %>%
  ggplot(aes(x = license, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single"), width = 0.75, size = 0.25) +
  labs(x = "", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2F.png", width = 5, height = 4)

# Panel G: Revisions per preprint for COVID vs non-COVID

p2G <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  count(covid_preprint, n_versions) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = n_versions, y = proportion, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single"), width = 0.75, size = 0.25) +
  labs(x = "Number of versions", y = "% of preprints", fill = "") +
  scale_x_continuous(breaks = seq(1:10)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  guides(fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_2G.png", width = 5, height = 4)

# Panel H: Word counts

p2H <- preprints %>%
  filter(posted_date >= "2020-01-01",
         source == "biorxiv",
         n_words != 0) %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = covid_preprint, y = n_words, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2, width = 0.3) +
  labs(x = "", y = "Word Count", fill = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE) +
  ggsave("outputs/figures/partials/Figure_2H.png", width = 5, height = 4)

# Panel I: Reference counts

p2I <- preprints %>%
  filter(posted_date >= "2020-01-01",
         source == "biorxiv") %>%
  mutate(covid_preprint = case_when(
      covid_preprint == T ~ "COVID-19 preprints",
      covid_preprint == F ~ "non-COVID-19 preprints"
    )) %>%
  ggplot(aes(x = covid_preprint, y = n_refs, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2, width = 0.3) +
  labs(x = "", y = "Reference Count", fill = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE) +
  ggsave("outputs/figures/partials/Figure_2I.png", width = 5, height = 4)

# define layout manually - see https://patchwork.data-imaginist.com/articles/guides/layout.html
layout <- "
AAAAAAAAAAAA
BBBBBBCCCCCC
DDDDDDEEEEEE
DDDDDDFFFFFF
GGGGGGHHHIII
"
p <- p2A + p2B + p2C + p2D + p2E + p2F + p2G + p2H + p2I +
  plot_layout(design = layout)

# For some reason this throws an error but still actually works fine...
p + plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_2.png", width = 10, height = 12) 
  
```

# Supplementary Figure 2:

```{r}

# Panel A: COVID vs non-COVID preprints for bioRxiv only

pS2A <- preprints %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ),
         source = factor(source, 
                         levels = c("biorxiv", "medrxiv"),
                         labels = c("bioRxiv", "medRxiv"))) %>%
  count(covid_preprint, source, posted_week) %>%
  complete(posted_week, nesting(covid_preprint, source), fill = list(n = 0)) %>%
  ggplot(aes(x = posted_week, y = n, fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +
  labs(x = "Posted date (week beginning)", y = "Preprints deposited", fill = "") +
  scale_y_continuous(labels = scales::comma) +
  custom_date_scale("2020-01-01", NA) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  facet_wrap(. ~ source, nrow = 2, strip.position = "right") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.background = element_rect(color = "grey90", fill = "grey95")) +
  ggsave("outputs/figures/partials/Figure_S2A.png", width = 10, height = 4)

# Panel B: Preprint screening time by server

pS2B <- preprints %>%
  filter(posted_date >= "2020-01-01")  %>%
  mutate(doi_date = gsub("\\.", "-", substr(doi, 9, 18)),
         days = as.numeric(ymd(posted_date) - ymd(doi_date))) %>%
  count(covid_preprint, source, days) %>%
  group_by(covid_preprint, source) %>%
  mutate(proportion = (n/sum(n)) * 100) %>%
  ungroup() %>%
  mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ),
         source = factor(source, 
                         levels = c("biorxiv", "medrxiv"),
                         labels = c("bioRxiv", "medRxiv"))) %>%
  ggplot(aes(x = days, y = proportion,  fill = covid_preprint)) +
  geom_col(color = "grey50", position = position_dodge(preserve = "single")) +    
  facet_wrap(source ~ ., nrow = 1) +
  labs(x = "Screening time (days)", y = "% of preprints", fill = "") +
  scale_x_continuous(breaks = seq(from = 0, to = 14, by = 1)) +
  coord_cartesian(xlim = c(0, 14)) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(strip.background = element_rect(color = "grey90", fill = "grey95")) +
  ggsave("outputs/figures/partials/Figure_S2B.png", width = 10, height = 4)

# Patchwork

# define layout 
layout <- "
AAAAAA
BBBBBB
"

p <- pS2A + pS2B +
  plot_layout(design = layout, guides = "collect", heights = c(2.5, 1)) & theme(legend.position = "top")
  
p + plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_S2.png", width = 10, height = 8)

```

# Figure 3: Preprint access

```{r}

# Prepare data
d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  group_by(doi, posted_date, covid_preprint) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ))

# Abstract views
p3A <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_3A.png", width = 10, height = 4)

# PDF downloads
p3B <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, color = covid_preprint,
             group = interaction(posted_week, covid_preprint))) +
  geom_boxplot(width = 4, outlier.shape = NA, 
               position = position_dodge(width = 4.5)) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2, 
              position = position_jitterdodge(jitter.width = 2, dodge.width = 4.5)) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  custom_date_scale("2020-01-01", "2020-04-30") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_3B.png", width = 10, height = 4)

# Patchwork
p3A + p3B + plot_layout(ncol = 1) +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_3.png", width = 10, height = 8)

```

# Supplementary Figure 3: Time prior to our study period

```{r}

# Panel A: Abstract views (bioRxiv + medRxiv, non-COVID)

d <- preprint_usage %>%
  inner_join(preprints, by = "doi") %>%
  filter(covid_preprint != T) %>%
  group_by(doi, posted_date) %>%
  summarize(full_text_views = sum(full_text_views),
            abstract_views = sum(abstract_views),
            pdf_downloads = sum(pdf_downloads)) %>%
  ungroup() %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1))

pS3A <- d %>%
  ggplot(aes(x = posted_week, y = abstract_views, group = posted_week)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2) +
  annotate("rect", xmin = ymd("2020-01-01"), xmax = ymd("2020-04-30"),
           ymin = 1, ymax = 1e5, fill = "red", alpha = 0.2) +
  labs(x = "Posted Date (week beginning)", y = "Total abstract views", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e5), expand = c(0, 0)) +
  custom_date_scale("2019-09-01", "2020-04-30") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S3A.png", width = 10, height = 4)

# Panel B: PDF downloads (bioRxiv + medRxiv, non-COVID)

pS3B <- d %>%
  ggplot(aes(x = posted_week, y = pdf_downloads, group = posted_week)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(shape = 21, size = 0.2, alpha = 0.2) +
  annotate("rect", xmin = ymd("2020-01-01"), xmax = ymd("2020-04-30"),
           ymin = 1, ymax = 1e5, fill = "red", alpha = 0.2) +
  labs(x = "Posted Date (week beginning)", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e5), expand = c(0, 0)) +
  custom_date_scale("2019-09-01", "2020-04-30") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S3B.png", width = 10, height = 4)

# Panel C: PDF downloads for additional preprint servers

# Build a search string containing terms related to COVID-19
search_string_covid <- "coronavirus|covid-19|sars-cov|ncov-2019|2019-ncov|hcov-19|sars-2"

# Read in and process data from other servers

# SSRN
ssrn_preprints <- read.csv("data/otherservers/ssrn_extract_3_LB.csv", 
                          stringsAsFactors = FALSE, 
                          fileEncoding = "UTF-8-BOM") %>%
 rename_all(~tolower(str_replace_all(.,"\\.|X\\.",""))) %>%
 group_by(abstract_id, ab_title) %>%
 summarise(pdf_downloads = sum(total_downloads)) %>%
 mutate(covid_preprint = case_when(
   str_detect(ab_title, regex(search_string_covid, ignore_case = TRUE)) ~ T, 
   T ~ F),
   source = "SSRN") %>% 
 ungroup()
 
# Research Square
ressquare_titles <- read.csv("data/otherservers/article_data.csv", 
                             stringsAsFactors = FALSE) %>% 
  select(article_identity, title)

ressquare_texts <- read.csv("data/otherservers/full_article_text-002.csv",
                            stringsAsFactors = FALSE) %>%
  select(article_identity, plain_abstract)

ressquare_preprints <- read.csv("data/otherservers/engagement_by_article_and_date.csv",
                                stringsAsFactors = FALSE) %>%
  left_join(ressquare_titles, by = "article_identity") %>%
  left_join(ressquare_texts, by = "article_identity") %>%
  group_by(article_identity, title, plain_abstract) %>%
  summarise(pdf_downloads = sum(downloads)) %>%
  mutate(covid_preprint = case_when(
    str_detect(title, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    str_detect(plain_abstract, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    T ~ F),
    source = "Research Square") %>%
  ungroup()

# Preprints.org
dotorg_preprints <- read.csv("data/otherservers/2020-01-01-2020-04-30_preprints_dot_org.csv",
                             stringsAsFactors = FALSE) %>%
  rename(pdf_downloads = downloads) %>%
  mutate(covid_preprint = case_when(
    str_detect(title, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    str_detect(abstract, regex(search_string_covid, ignore_case = TRUE)) ~ T,
    T ~ F),
    source = "Preprints.org")

# Bind into one data frame
all_server_dloads <- bind_rows(preprints_epi_period %>%
                                  select(source, covid_preprint, doi) %>%
                                  inner_join(preprint_usage %>% select(doi, pdf_downloads), by = "doi") %>%
                                  select(-doi),
                                ssrn_preprints %>% select(source, covid_preprint, pdf_downloads),
                                ressquare_preprints %>% select(source, covid_preprint, pdf_downloads),
                                dotorg_preprints %>% select(source, covid_preprint, pdf_downloads))

# Generate plot
pS3C <- all_server_dloads %>%
    mutate(covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         )) %>%
  ggplot(aes(x = source, y = pdf_downloads, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "Preprint server", y = "Total PDF downloads", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, limits = c(1, 1e6), expand = c(0, 0)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(legend.position = "top") + 
  ggsave("outputs/figures/partials/Figure_S3C.png", width = 10, height = 4)

# Patchwork
pS3A + pS3B + pS3C +
  plot_layout(nrow = 3) +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_S3.png", width = 10, height = 10)

```

# Figure 4: Preprint usage and sharing

```{r}

# Prepare data
d <- preprint_citations %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  inner_join(preprints, by = "doi") %>%
  filter(posted_date >= "2020-01-01") %>%
  mutate(posted_week = floor_date(posted_date, unit = "week", week_start = 1),
         covid_preprint = case_when(
           covid_preprint == T ~ "COVID-19 preprints",
           covid_preprint == F ~ "non-COVID-19 preprints"
         ))

# Panel A: Citations per preprint (COVID vs non-COVID)

p4A <- d %>%
  ggplot(aes(x = covid_preprint, y = citations + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Citations", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4A.png", width = 5, height = 4)

# Panel B: Tweets per preprint (COVID vs non-COVID)

p4B <- d %>%
  ggplot(aes(x = covid_preprint, y = twitter + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Tweets", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4B.png", width = 5, height = 4)

# Panel C: News mentions per preprint (COVID vs non-COVID)

p4C <- d %>%
  ggplot(aes(x = covid_preprint, y = news + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "News Articles", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4C.png", width = 5, height = 4)  

# Panel D: Blog mentions per preprint (COVID vs non-COVID)

p4D <- d %>%
  ggplot(aes(x = covid_preprint, y = blogs + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), shape = 21, size = 0.5, alpha = 0.4, width = 0.25) +
  labs(x = "", y = "Blogs", 
       fill = "", color = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_4D.png", width = 5, height = 4)

# Panels E and F: Correlation plots between Citations, tweets, news articles and blogs

covid_usage <- d %>% 
  filter(covid_preprint == "COVID-19 preprints") %>%
  select(citations, twitter, news, blogs)

non_covid_usage <- d %>% 
  filter(covid_preprint == "non-COVID-19 preprints") %>%
  select(citations, twitter, news, blogs)

covid_corr <- correlate(covid_usage, method = "spearman") %>%
  pivot_longer(citations:blogs) %>%
  rename(rows = rowname,
         cols = name) %>%
  filter(str_trunc(rows, 1, ellipsis = "") < str_trunc(cols, 1, ellipsis = ""))

non_covid_corr <- correlate(non_covid_usage, method = "spearman") %>%
  pivot_longer(citations:blogs) %>%
  rename(rows = rowname,
         cols = name) %>%
  filter(str_trunc(rows, 1, ellipsis = "") < str_trunc(cols, 1, ellipsis = ""))

p4E <- covid_corr %>%
  ggplot(aes(x = rows, y = cols, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_continuous_sequential(palette = "Reds3", 
                                   breaks = c(0, 0.5, 1), 
                                   limits = c(0, 1)) +
  labs(x = "", y = "", title = "COVID-19 preprints",
       fill = "Spearman Correlation") +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 10)) +
  guides(fill = guide_colourbar(title.position="top", 
                                title.hjust = 0.5,
                                label.position = "bottom",
                                barwidth = 7)) +
  ggsave("outputs/figures/partials/Figure_4E.png", width = 5, height = 4)

p4F <- non_covid_corr %>%
  ggplot(aes(x = rows, y = cols, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_continuous_sequential(palette = "Reds3", 
                                   breaks = c(0, 0.5, 1), 
                                   limits = c(0, 1)) +
  labs(x = "", y = "", title = "non-COVID-19 preprints",
       fill = "Spearman Correlation") +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 10)) +
  guides(fill = guide_colourbar(title.position="top", 
                                title.hjust = 0.5,
                                label.position = "bottom",
                                barwidth = 7)) +
  ggsave("outputs/figures/partials/Figure_4F.png", width = 5, height = 4)




# Patchwork
# Manually define layout
layout <- "
ABCD
#EF#
#GH#
"
p <- plot_spacer() + p4A + p4B + plot_spacer() + p4C + p4D + p4E + p4F + 
  plot_layout(design = layout, guides = "collect") & theme(plot.margin = margin(0, 0, 0, 0),
                                                           legend.title = element_text(size = 10),
                                                           legend.position = "bottom")

p +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_4.png", width = 10, height = 10)
  
```

# Supplementary Figure 4: Twitter word clouds, sentiment

```{r}
# Here we generate Supplementary Figure 4. The method is a little messy, as we
# generate wordclouds and venn diagrams which do not seem to play well with 
# ggplot objects. Thus, we create each panel and save it as a separate PNG.
# Panels are then arranged using cowplots "ggdraw" function. 

# Make Wordclouds (Figs S4A, S4C, S4E, S4G)

library(wordcloud2)
# The below packages are necessary for exporting wordclouds to PNG, see
# https://www.r-graph-gallery.com/196-the-wordcloud2-library.html
library("htmlwidgets")
library("webshot")
#webshot::install_phantomjs()
library(eulerr)
library(cowplot)

# Read tweet data (not shared publicly at the moment)
tweets <- read_csv("data/preprint_tweets_20190901_20200430.csv")

# First we make a wordcloud for tweets of all top-10 tweeted articles
top_preprints <- preprints %>% 
  inner_join(preprint_altmetrics, by = "doi") %>%
  filter(covid_preprint == T) %>% 
  top_n(10, twitter) %>% 
  arrange(desc(twitter)) %>% 
  pull(doi)

# Find hashtags associated with top-10 most tweeted covid-19 preprints, only original tweets
hashtags <- tweets %>%
  filter(doi %in% top_preprints) %>% 
  filter(is_retweet == F) %>% 
  select(hashtags) %>%
  na.omit() %>%
  mutate(hashtags = strsplit(as.character(hashtags), ",")) %>% 
  unnest(hashtags) %>%
  mutate(hashtags = str_remove_all(hashtags, "[^a-zA-Z0-9]"), # remove special characters
         hashtags = str_to_lower(hashtags)) %>% # convert all hashtags to lowercase
  filter(!hashtags %in% c("", "covid19", "coronavirus", "ncov2019", "covid", "covid2019", "sarscov2", "2019ncov", "hcov19", "19", "novelcoronavirus", "corona", "coronaovirus", "coronarovirus", "coronarvirus")) %>% # remove empty hashtags and specific keywords
  count(hashtags) %>%
  mutate(n = log(n+1))

# Generate the wordcloud
p <- wordcloud2(hashtags, color = "random-dark", size = .15)

# Save the wordcloud to a PNG
saveWidget(p, "temp.html", selfcontained = F)
webshot("temp.html","outputs/figures/partials/Figure_S4A.png", 
        delay = 5, vwidth = 480, vheight = 360)


# Define a function for generating a wordcloud for individual preprints (using
# the same method as above). We take a preprint by its position in the top 10,
# and also pass the associated figure label

plotWordCloudForPreprint <- function(position, label) {

p_doi <- top_preprints[position]  
  
hashtags <- tweets %>%
  filter(doi %in% p_doi) %>% 
  filter(is_retweet == F) %>% 
  select(hashtags) %>%
  na.omit() %>%
  mutate(hashtags = strsplit(as.character(hashtags), ",")) %>% 
  unnest(hashtags) %>%
  mutate(hashtags = str_remove_all(hashtags, "[^a-zA-Z0-9]"), # remove special characters
         hashtags = str_to_lower(hashtags)) %>% # convert all hashtags to lowercase
  filter(!hashtags %in% c("", "covid19", "coronavirus", "ncov2019", "covid", "covid2019", "sarscov2", "2019ncov", "hcov19", "19", "novelcoronavirus", "corona", "coronaovirus", "coronarovirus", "coronarvirus")) %>% # remove empty hashtags and specific keywords
  count(hashtags) %>%
  mutate(n = log(n+1))

p <- wordcloud2(hashtags, color = "random-dark", size = .15)

saveWidget(p, "temp.html", selfcontained = F)
webshot("temp.html", str_c("outputs/figures/partials/Figure_", label, ".png"), 
        delay = 5, vwidth = 480, vheight = 360)
}

# Generate the wordclouds for each preprint (argument 1 = positions of preprints
# in the list of top 10, argument 2 = figure labels)
purrr::walk2(c(1,5,7), c("S4D", "S4F", "S4H"), plotWordCloudForPreprint)

# Plot the distributions of hashtags for selected preprints from the top-10 most tweeted

plotDistributionForPreprint <- function(position, label) {
  
p_doi <- top_preprints[position]  
  
# Find hashtags associated with top-10 most tweeted covid-19 preprints, only original tweets
hashtags <- tweets %>%
  filter(doi %in% p_doi) %>% 
  filter(is_retweet == F) %>% 
  select(hashtags) %>%
  na.omit() %>%
  mutate(hashtags = strsplit(as.character(hashtags), ",")) %>% 
  unnest(hashtags) %>%
  mutate(hashtags = str_remove_all(hashtags, "[^a-zA-Z0-9]"), # remove special characters
         hashtags = str_to_lower(hashtags)) %>% # convert all hashtags to lowercase
  filter(!hashtags %in% c("", "covid19", "coronavirus", "ncov2019", "covid", "covid2019", "sarscov2", "2019ncov", "hcov19", "19", "novelcoronavirus", "corona", "coronaovirus", "coronarovirus", "coronarvirus")) %>% # remove empty hashtags and specific keywords
  count(hashtags) %>%
  top_n(10, n) %>%
  ggplot(aes(x = hashtags, y = n)) +
  geom_col(color = "grey50", size = 0.25, 
           fill = qualitative_hcl(n = 1,palette = "Set2")) +
  labs(x = "", y = "Frequency") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank()) +
  ggsave(str_c("outputs/figures/partials/Figure_", label, ".png"),
         width = 4, height = 3)
}

# Generate the distributions for each preprint (argument 1 = positions of preprints
# in the list of top 10, argument 2 = figure labels)
purrr::walk2(c(1,5,7), c("S4E", "S4G", "S4I"), plotDistributionForPreprint)

# Generate a Venn diagram of overlap between the top-10 most tweeted, most mentioned
# in news and blogs, and most cited. Here we use the eulerr package

top_twitter <- preprints %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  filter(covid_preprint == T) %>%
  top_n(10, twitter) %>%
  pull(doi)

top_news <- preprints %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  filter(covid_preprint == T) %>%
  top_n(10, news) %>%
  pull(doi)

top_blogs <- preprints %>%
  inner_join(preprint_altmetrics, by = "doi") %>%
  filter(covid_preprint == T) %>%
  top_n(10, blogs) %>%
  pull(doi)

top_cited <- preprints %>%
  inner_join(preprint_citations, by = "doi") %>%
  filter(covid_preprint == T) %>%
  top_n(10, citations) %>%
  pull(doi)

top_policy <- preprints %>%
  inner_join(preprint_policy, by = "doi") %>%
  filter(covid_preprint == T) %>%
  top_n(10, policy_mined) %>%
  pull(doi)

fit <- list(
    Twitter = top_twitter,
    News = top_news,
    Blogs = top_blogs,
    Citations = top_cited,
    Policy = top_policy)

# Output the Venn diagram to a PNG
png(filename = "outputs/figures/partials/Figure_S4B.png",
    width = 480, height = 360)
plot(euler(fit), 
     fills = qualitative_hcl(n = 5, palette = "Set2"),
     alpha = 0.75,
     labels = list(cex = 1),
     quantities = list(cex = 1),
     width = 200)
dev.off()

# Twitter sentiment analysis
preprint_tweets_sent <- read.csv("data/preprint_sentiment_tweets_20190901_20200430.csv") %>%
    mutate(twitter_rank = factor(twitter_rank, levels=c(1:10)))

pS4C <- preprint_tweets_sent %>%
  filter(ave_sentiment != 0 ) %>%
  ggplot(aes(x = twitter_rank, y = ave_sentiment, label=title)) +
  geom_boxplot(outlier.shape = NA, color = qualitative_hcl(1, palette = "Set2")) +
  geom_jitter(fill = qualitative_hcl(1, palette = "Set2"),
              color = qualitative_hcl(1, palette = "Set2"),
              shape = 21, size = 0.5, alpha = 0.2, width = 0.25) +  
  labs(x = "Ranking (number of tweets)", y = "Tweet sentiment polarity score", 
       fill = "", color = "") +
  guides(color = FALSE, fill = FALSE) +
  scale_y_continuous(limits = c(-2.5, 5)) +
  ggsave("outputs/figures/partials/Figure_S4C.png", width = 10, height = 5)

# Now we fit all the PNG files together. Some manual adjustments may be necessary

pS4A <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4A.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4B <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4B.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4D <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4D.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4E <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4E.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4F <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4F.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4G <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4G.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4H <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4H.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

pS4I <- ggdraw() +
  draw_image("outputs/figures/partials/Figure_S4I.png") +
  theme(plot.margin = margin(5, 5, 5, 5))

# Patchwork

layout <- "
AB
CC
DE
FG
HI
"

pS4A + pS4B + pS4C + pS4D + pS4E + pS4F + pS4G + pS4H + pS4I +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_S4.png",
         height = 15, width = 10)

```

# Figure 5: Publishing timelines, categories, and preprint-published paper changes

```{r}

# Panel A: Percentage of preprints published

p5A <- preprints %>% 
  filter(posted_date >= "2020-01-01") %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    covid_preprint == F ~ "non-COVID-19 preprints")
  ) %>% 
  count(covid_preprint, is_published) %>%
  group_by(covid_preprint) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(is_published == T) %>%
  ggplot(aes(x = covid_preprint, y = prop, fill=covid_preprint)) +
  geom_col(color = "grey50", size = 0.25, position = "dodge") +
  labs(x = "", y = "% of preprints published", fill ="") +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.title.x = element_blank(),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_5A.png", width = 5, height = 4)

# Panel B: Publishing timeline

p5B <- preprints %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID-19 preprints",
    (covid_preprint == F & posted_date >= "2020-01-01") ~ "non-COVID-19 preprints",
    T ~ "Sep-Dec 2019")) %>%
  mutate(pub_bracket = cut(as.numeric(delay_in_days), 
                           seq(0, 240, by = 10), 
                           labels=seq(0, 230, by = 10))) %>%
  group_by(covid_preprint) %>%
  count(pub_bracket) %>%
  mutate(prop = n*100 / sum(n)) %>%
  filter(!is.na(pub_bracket)) %>%
  ggplot(aes(x = pub_bracket, y = prop, fill=covid_preprint, color=covid_preprint)) +
  geom_bar(alpha = 0.25, width = 1, size = 0.25, 
           stat = "identity", position="identity") +
  scale_x_discrete(labels = c("0","","","","","50","","","","","100","","","","","150","","","","","200","","","")) +
  labs(x = "Time from preprint posting to publication (days)",
       y = "% of all preprints") +
  scale_color_manual(values = qualitative_hcl(3, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(3, palette = "Set2")) +
  theme(legend.title = element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 8)) +
  ggsave("outputs/figures/partials/Figure_5B.png", width = 5, height = 4)

# Panel C: Science focus of corresponding author

# For each author, select their chronologically latest COVID-19 preprint
preprint_author_last_covid <- preprints %>% 
  filter(covid_preprint == T) %>% 
  arrange(posted_date) %>% 
  group_by(author_corresponding) %>% 
  slice(n()) %>%
  select(author_corresponding, category, posted_date) %>%
  rename(category_covid = category,
         posted_covid = posted_date)

# For each author, select their non-COVID-19 preprints
preprint_author_last_non_covid <- preprints_all %>% 
  filter(covid_preprint == F) %>% 
  arrange(posted_date) %>% 
  group_by(author_corresponding) %>% 
  select(author_corresponding, category, posted_date) %>%
  rename(category_previous = category,
         posted_previous = posted_date)

# Filter to non-COVID-19 preprints uploaded before the latest COVID-19 preprint and select the chronologically latest
preprint_author_last <- preprint_author_last_covid %>%
  inner_join(preprint_author_last_non_covid, by = "author_corresponding") %>%
  filter(posted_covid >= posted_previous) %>%
  slice(n()) %>%
  mutate(category_covid = tolower(category_covid),
         category_previous = tolower(category_previous))

total_cats <- c(preprint_author_last$category_covid, preprint_author_last$category_previous) %>% unique %>% sort

# Plot alluvial diagram
p5C <- preprint_author_last %>%
  mutate(category_covid = factor(category_covid, levels = total_cats),
         category_previous = factor(category_previous, levels = total_cats)) %>%
  group_by(category_covid, category_previous) %>%
  summarize(freq = n()) %>%
  ungroup() %>%
  filter(freq >= 5) %>%
  ggplot(aes(axis1 = category_previous, axis2 = category_covid, y = freq)) +
  scale_x_discrete(limits = c("Previous", "COVID-19"), 
                   expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Preprint categorisation") +
  geom_alluvium(aes(fill = category_previous), reverse = TRUE) +
  geom_stratum(reverse = TRUE, color = "grey") + 
  geom_text(size = 2.5, stat = "stratum", label.strata = TRUE, reverse = TRUE) +
  guides(fill = FALSE) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  ggsave("outputs/figures/partials/Figure_5C.png", width = 5, height = 8)

# Panel D: Count of comments per preprint
p5D <- preprint_comments %>%
  inner_join(preprints, by = "doi") %>%
  filter(posted_date >= "2020-01-01") %>% 
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprints",
    covid_preprint == F ~ "non-COVID preprints")) %>% 
  ggplot(aes(x = covid_preprint, y = comments_count + 1, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)), 
              shape = 21, size = 0.5, alpha = 0.5, width = 0.25) +
  labs(x = "", y = "Comments per preprint", fill = "") +
  scale_y_log10(labels = scales::comma, expand = c(0, 0.1)) +  
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  theme(legend.position = "none") +
  ggsave("outputs/figures/partials/Figure_5D.png", width = 5, height = 4) 

# Panel E: Change in abstract between preprint and published paper

p5E <- preprint_changes %>%
  rename(abstract_change = starts_with("Has the abstract changed?")) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprints",
    covid_preprint == F ~ "non-COVID preprints"),
    abstract_change = factor(abstract_change, 
                             levels = c(-1, 0, 1, 2),
                             labels = c("No abstract in published paper", 
                                        "No change", 
                                        "Softening/strengthening of conclusions", 
                                        "Major change in conclusions"))) %>%
  count(covid_preprint, abstract_change) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup %>%
  ggplot(aes(x = abstract_change, y = proportion, fill = covid_preprint)) +
  geom_col(position = "dodge", color = "grey50", size = 0.25) +
  labs(title = "Change in abstract", x="", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(n = 2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none",
        plot.title = element_text(size = 10)) +
  ggsave("outputs/figures/partials/Figure_5E.png", width = 5, height = 4) 

# Panel F: Change in main body between preprint and published paper

p5F <- preprint_changes %>%
  rename(change_outcomes = starts_with("Does the change between preprint and paper in the main figures (including tables) reflect a change in content or outcomes?")) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprint",
    covid_preprint == F ~ "non-COVID preprint"),
    change_outcomes = factor(change_outcomes, 
                             levels = c(0:4),
                             labels = c("No real change", 
                                        "Figures rearranged", 
                                        "Significant content added", 
                                        "Significant content removed", 
                                        "Content added and removed"))) %>%
  count(covid_preprint, change_outcomes) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup %>%
  ggplot(aes(x = change_outcomes, y = proportion, fill = covid_preprint)) +
  geom_col(position = "dodge", color = "grey50", size = 0.25) +
  labs(title = "Change in figures and tables", x = "", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(n = 2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none",
        plot.title = element_text(size = 10)) +
  ggsave("outputs/figures/partials/Figure_5F.png", width = 5, height = 4) 

# Patchwork

# Defone layout
layout <- "
AAABBB
CCCDDD
CCCEEE
CCCFFF
"

p5A + p5B + p5C + p5D + p5E + p5F +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A") +
  ggsave("outputs/figures/Figure_5.png", width = 10, height = 12)

```

# Supplementary Figure 5: Preprint - published article changes

```{r}

# Panel A: Journal locations of published papers

pS5A <- preprints %>%
  filter(covid_preprint == T) %>%
  count(published_journal) %>%
  filter(n >= 3) %>%
  na.omit() %>%
  ggplot(aes(x = published_journal, y = n)) +
  geom_col(color = "grey50", fill = qualitative_hcl(n = 1, palette = "Set2"),
           position = "dodge", size = 0.25) +
  labs(x = "", y = "Number of preprints", fill = "") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) +
  ggsave("outputs/figures/partials/Figure_S5A.png", width = 5, height = 4) 

# Panel B: Time to publication for different publishers

top_publishers <- preprints %>%
  filter(covid_preprint == T,
         posted_date >= "2020-01-01") %>%
  count(published_publisher) %>%
  filter(n >= 4) %>%
  na.omit() %>%
  pull(published_publisher)

pS5B <- preprints %>%
  filter(posted_date >= "2020-01-01",
         published_publisher %in% top_publishers) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprint",
    covid_preprint == F ~ "non-COVID preprint"),
    published_publisher = factor(published_publisher,
                                 levels = c("American Association for the Advancement of Science (AAAS)",
                                            "American Society for Microbiology",
                                            "Elsevier BV",
                                            "MDPI AG",
                                            "Oxford University Press (OUP)",
                                            "Public Library of Science (PLoS)",
                                            "Springer Science and Business Media LLC",
                                            "Wiley"),
                                 labels = c("AAAS", "ASM", "Elsevier", "MDPI", "OUP", "PLoS", "Springer", "Wiley"))) %>%
  filter(delay_in_days > 0) %>%
  ggplot(aes(x = published_publisher, y = delay_in_days, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = factor(covid_preprint)),
              shape = 21, size = 0.2, alpha = 0.2,
              position = position_jitterdodge(jitter.width = 0.5)) + 
  labs(x = "", y = str_wrap("Time from preprint posting to publication (days)", 30), fill = "", color = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_fill_manual(values = qualitative_hcl(2, palette = "Set2")) +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        legend.position = "top") +
  guides(fill = F) +
  ggsave("outputs/figures/partials/Figure_S5B.png", width = 5, height = 4) 

# Panel C: Comment sentiment

preprint_comments_sent <- read.csv("data/preprint_sentiment_comments_20190901_20200430.csv") %>%
  mutate(comment_rank = factor(comment_rank, levels=c(1:10)))

pS5C <- preprint_comments_sent %>%
  ggplot(aes(x = comment_rank, y = ave_sentiment, label = title)) +
  geom_boxplot(outlier.shape = NA, color = qualitative_hcl(1, palette = "Set2")) +
  geom_jitter(fill = qualitative_hcl(1, palette = "Set2"),
              color = qualitative_hcl(1, palette = "Set2"),
              shape = 21, size = 1, alpha = 0.4, width = 0.4) + 
  labs(x = "Ranking (number of comments)", y = "Comment sentiment polarity score", 
       fill = "", color = "") +
  guides(color = FALSE, fill = FALSE) +
  ggsave("outputs/figures/partials/Figure_S5C.png", width = 10, height = 5)

# Panel D: Transparent peer review

pS5D <- preprint_changes %>%
  rename(peer_review = starts_with("Are open peer reviews and decision letters available?")) %>%
  mutate(
    covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprints",
    covid_preprint == F ~ "non-COVID preprints"),
    peer_review = factor(peer_review, 
                         levels = c(0:1),
                         labels = c("No", "Yes"))) %>%
  count(covid_preprint, peer_review) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  ggplot(aes(x = peer_review, y = proportion, fill = covid_preprint)) +
  geom_col(position = "dodge", color = "grey50", size = 0.25) +
  labs(x = "Transparency of peer-review", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(n = 2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_S5D.png", width = 5, height = 4)

# Panel E: Data availability

pS5E <- preprint_changes %>%
  rename(source_data = starts_with("Is the source data (including code) more accessible after publication?")) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprints",
    covid_preprint == F ~ "non-COVID preprints"),
    source_data = factor(source_data, 
                         levels = c(-2, -1, 0, 1, 2),
                         labels = c("Less accessible",
                                    "Upon request", 
                                    "Supplemental or repository", 
                                    "More available",
                                    "NA"))) %>%
  count(covid_preprint, source_data) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  ggplot(aes(x = source_data, y = proportion, fill = covid_preprint)) +
  geom_col(position = "dodge", color = "grey50", size = 0.25) +
  labs(x = "Data availability", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(n = 2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_S5E.png", width = 5, height = 4)

# Panel F: Change in authorship

pS5F <- preprint_changes %>%
  rename(author_list = starts_with("Has the author list changed?")) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprints",
    covid_preprint == F ~ "non-COVID preprints"),
    author_list = factor(author_list,
                         levels = c(0:5),
                         labels = c("no change",
                                    "Author added",
                                    "Author removed",
                                    "Change in corressponding author",
                                    "Added & corressponding author change",
                                    "Removed & corressponding author change"))) %>%
  count(covid_preprint, author_list) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  ggplot(aes(x = author_list, y = proportion, fill = covid_preprint)) +
  geom_col(position = "dodge", color = "grey50", size = 0.25) +
  labs(x = "Change in authorship", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(n = 2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_S5F.png", width = 5, height = 4)
  
# Panel G: Difference in number of figure/table panels

pS5G <- preprint_changes %>%
  rename(preprint = starts_with("How many figure panels and tables in the preprint in total?"),
         paper = starts_with("How many figure panels and tables in the paper in total?")) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID preprints",
    covid_preprint == F ~ "non-COVID preprints"),
    panel_change = paper - preprint,
    panel_change = case_when(
      panel_change > 5 ~ ">5",
      panel_change < -5 ~ "<-5",
      T ~ as.character(panel_change)
    ),
    panel_change = factor(panel_change,
                          levels = c("<-5", "-5", "-4", "-3", "-2", "-1", "0", "1", "2", "3", "4", "5", ">5"),
                          labels = c("<-5", "-5", "-4", "-3", "-2", "-1", "0", "1", "2", "3", "4", "5", ">5"))) %>% 
  count(covid_preprint, panel_change) %>%
  group_by(covid_preprint) %>%
  mutate(proportion = (n/sum(n))*100) %>%
  ungroup() %>%
  ggplot(aes(x = panel_change, y = proportion, fill = covid_preprint)) +
  geom_col(position = "dodge", color = "grey50", size = 0.25) +
  labs(x = "Change in total number of panels", y = "% of preprints", fill = "") +
  scale_fill_manual(values = qualitative_hcl(n = 2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_S5G.png", width = 5, height = 4)

pS5H <- preprint_changes %>%
  rename(preprint = starts_with("How many figure panels and tables in the preprint in total?"),
         paper = starts_with("How many figure panels and tables in the paper in total?")) %>%
  mutate(covid_preprint = case_when(
    covid_preprint == T ~ "COVID",
    covid_preprint == F ~ "non-COVID")) %>%
  select(covid_preprint, preprint, paper) %>%
  pivot_longer(preprint:paper) %>%
  mutate(name = str_c(covid_preprint, " ", name),
         name = factor(name,
                       levels = c("COVID preprint",
                                  "COVID paper",
                                  "non-COVID preprint",
                                  "non-COVID paper"))) %>%
  ggplot(aes(x = name, y = value, color = covid_preprint)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = covid_preprint), 
              shape = 21, size = 0.5, alpha = 0.2, width = 0.3) +
  labs(x = "", y = "Total panels and tables", fill = "", color = "") +
  scale_color_manual(values = qualitative_hcl(2, palette = "Set2")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  guides(fill = F) +
  theme(legend.position = "top") +
  ggsave("outputs/figures/partials/Figure_S5H.png", width = 5, height = 4)

# Patchwork

# Define layout
layout <- "
AB
CD
EF
GH"

pS5A + pS5B + pS5C + pS5D + pS5E + pS5F + pS5G + pS5H +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A") +
    ggsave("outputs/figures/Figure_S5.png", width = 10, height = 15)

```
